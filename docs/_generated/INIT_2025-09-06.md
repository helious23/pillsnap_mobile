# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-06)

## 📋 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|--------|
| CLAUDE_MEMORY.md | docs/ | 2025-09-05 21:53 | 절대 수칙, 즉시 실행, Phase 상태 |
| implementation_guide.md | docs/2025-09-05_ | 2025-09-05 20:32 | 촬영 내역, 즐겨찾기, Repository |
| remaining_features.md | docs/2025-09-05_ | 2025-09-05 20:30 | 남은 기능, 구현 가이드 |
| signup-flow-fixes.md | docs/2025-01-03_ | 2025-09-05 00:36 | 회원가입, 에러 처리 |
| supabase_integration.md | docs/2025-09-04_ | 2025-09-04 20:06 | Supabase, 인증, 테이블 |
| supabase_schema.md | docs/2025-09-04_ | 2025-09-04 19:50 | DB 스키마, 마이그레이션 |
| camera_modifications.md | docs/ | 2025-09-03 23:43 | 카메라 단순화, 제거 기능 |
| IMAGE_OPTIMIZATION.md | docs/ | 2025-09-03 20:46 | 이미지 최적화, 압축 |
| API_INTEGRATION.md | docs/ | 2025-09-03 19:50 | API 연동, 엔드포인트 |
| ARCHITECTURE.md | docs/ | 2025-09-03 09:56 | Clean Architecture, 레이어 |

## 🏗️ 아키텍처 규칙 (정규화 본문)

### 1. 폴더 구조 표준

**절대 규칙**: `features/<feature>/{presentation,domain,data}` 계층 필수

```
lib/
├── core/                       # 앱 전역 공통
│   ├── error/                  # 에러 처리 (exceptions, failures)
│   ├── network/                # 네트워크 설정 (api_client)
│   ├── widgets/                # 공통 위젯
│   ├── utils/                  # 유틸리티 (validators, formatters)
│   ├── router/                 # go_router 설정
│   │   ├── app_router.dart     # 라우터 구성
│   │   └── route_paths.dart    # 🔴 라우트 경로 상수 (필수)
│   └── i18n/                   # 국제화 헬퍼
├── theme/                      # 디자인 시스템
│   ├── app_theme.dart          # Material 테마
│   ├── app_colors.dart         # 색상 토큰
│   ├── app_typography.dart     # 타이포그래피
│   ├── app_spacing.dart        # 간격 시스템
│   └── app_dimensions.dart     # 크기, 반경
├── features/
│   └── <feature>/
│       ├── presentation/       # UI 레이어
│       │   ├── pages/
│       │   ├── widgets/
│       │   └── controllers/    # Riverpod Notifier
│       ├── domain/             # 비즈니스 로직
│       │   ├── entities/
│       │   ├── repositories/   # 인터페이스
│       │   └── usecases/
│       └── data/               # 데이터 레이어
│           ├── datasources/
│           ├── models/         # freezed 모델
│           └── repositories/   # 구현체
└── l10n/                       # ARB 파일
    ├── app_ko.arb
    └── app_en.arb
```

### 2. 라우팅 규칙

- **필수**: `go_router` 사용
- **경로 상수**: `core/router/route_paths.dart`에만 정의
- **ShellRoute**: 공통 레이아웃 (MainShell with BottomNav)
- **리다이렉트**: 인증 기반 가드
- **딥링크**: app_links 패키지 사용 (uni_links 대체)

### 3. 상태관리 원칙

- **Riverpod 최신 API**: `AsyncNotifier`/`Notifier`만 사용
- **금지**: StateProvider, StateNotifierProvider (레거시)
- **네이밍**: `xxxProvider`, `XxxNotifier`, `XxxState`
- **Provider 스코프**: ProviderScope 최상위 래핑

### 4. 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현체(data)
- **UseCase**: 단일 책임, `call()` 메서드
- **Entity**: 불변 객체, freezed 사용
- **에러 처리**: `Either<Failure, T>` 또는 `try-catch`

### 5. 테마/토큰 시스템

- **하드코딩 금지**: 모든 스타일값은 토큰 참조
- **색상**: `AppColors.primary`, `AppColors.textPrimary`
- **간격**: `AppSpacing.xs/sm/md/lg/xl/xxl`
- **타이포**: `AppTextStyles.h1/h2/body`
- **withOpacity 금지**: `withValues(alpha: value)` 사용

### 6. 국제화(i18n)

- **gen_l10n**: Flutter 공식 도구 사용
- **ARB 파일**: `lib/l10n/app_ko.arb` (한국어 우선)
- **문장 제한**: 2줄 이내
- **키 네이밍**: `snake_case` (예: `login_button_text`)

### 7. 테스트/품질

- **린트**: `flutter_lints` 패키지
- **분석**: `flutter analyze` 에러 0개
- **코드 생성**: `build_runner` 사용
- **테스트 구조**: `test/{unit,widget,integration}/`

### 8. Phase 계획 (현재 상태)

- ✅ **Phase 0-4**: 완료 (기본 설정, Auth, Onboarding, Home, Camera UI)
- 🔄 **Phase 5-6**: 대기 (Drug Detail, Settings)  
- 🔄 **Phase 7-10**: 예정 (공통 컴포넌트, 라우팅 통합, i18n, 검증)

## ⚠️ 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| **라우트 상수 파일 누락** | route_paths.dart 파일 없음 | 즉시 생성 필수 | 🔴 높음 |
| **Supabase vs API 이중화** | 두 백엔드 동시 존재 | Supabase 메인 사용 | 🟡 중간 |
| **진행률 불일치** | 40% vs 65% 상이 | 65% 기준 통일 | 🟢 낮음 |
| **settings 기능 중복** | user_settings vs settings feature | settings feature로 통합 | 🟡 중간 |
| **카메라 실제 촬영 미구현** | UI만 완료, 기능 미완성 | camera 패키지 연동 필요 | 🔴 높음 |
| **Drug Detail 미구현** | Phase 5 대기 상태 | 즉시 착수 필요 | 🔴 높음 |

## ✅ 실행 체크리스트

### 🔴 즉시 실행 (오늘)

- [ ] **라우팅 상수 파일 생성** (S, 5분, 블로커 없음)
  ```bash
  touch lib/core/router/route_paths.dart
  ```

- [ ] **l10n 설정** (S, 10분, 블로커 없음)
  ```bash
  cat > l10n.yaml << EOF
  arb-dir: lib/l10n
  template-arb-file: app_ko.arb
  output-localization-file: app_localizations.dart
  EOF
  mkdir -p lib/l10n && touch lib/l10n/app_{ko,en}.arb
  ```

- [ ] **withOpacity 검색/교체** (S, 15분, 블로커 없음)
  ```bash
  grep -r "withOpacity" lib/
  # 발견 시 수동 교체: withOpacity(0.5) → withValues(alpha: 128)
  ```

- [ ] **환경변수 실행 스크립트** (S, 5분, 블로커 없음)
  ```bash
  chmod +x scripts/run_with_supabase.sh
  ./scripts/run_with_supabase.sh
  ```

### 🟡 우선순위 높음 (이번 주)

- [ ] **촬영 내역 저장/조회 구현** (M, 2시간, Supabase 연동 필요)
  - CaptureRepository 생성
  - Provider 구성
  - UI 연결

- [ ] **즐겨찾기 기능 구현** (S, 1시간, favorites 테이블 준비됨)
  - FavoriteButton 위젯
  - Repository/Provider

- [ ] **Drug Detail 페이지 완성** (M, 3시간, API 연동 필요)
  - 4개 탭 구성 (성분, 효능, 용법, 주의사항)
  - 약품 이미지 확대 모달

- [ ] **카메라 실제 촬영 구현** (L, 4시간, camera 패키지)
  - 이미지 캡처
  - Storage 업로드
  - API 분석 요청

### 🟢 중간 우선순위 (다음 주)

- [ ] **내가 먹는 약 등록** (M, 2시간, medications 테이블)
- [ ] **알러지 정보 관리** (S, 1시간, profiles 확장)
- [ ] **Settings 페이지 구현** (M, 2시간, UI 작업)
- [ ] **알림 설정** (M, 3시간, notification_settings 테이블)

## 📊 Phase 맵핑 (Gap 분석)

| Phase | 계획 | 현재 상태 | Gap | 조치 |
|-------|------|-----------|-----|------|
| 0-4 | 기본 구조 | ✅ 완료 | - | - |
| 5 | Drug Detail | ⏸️ 대기 | 100% | 즉시 착수 |
| 6 | Settings | ⏸️ 대기 | 100% | Phase 5 후 |
| 7 | 공통 컴포넌트 | 🔄 부분 | 50% | 점진적 추출 |
| 8 | 라우팅 통합 | ✅ 완료 | - | - |
| 9 | i18n | 🔄 부분 | 70% | ARB 파일 작성 |
| 10 | 최종 검증 | ⏸️ 대기 | 100% | 전체 완료 후 |

## 🚨 리스크/의존성

### 외부 의존성
- **Supabase**: 인증/데이터 저장 (필수)
- **PillSnap API**: 약품 분석 (필수)
- **카메라 권한**: iOS/Android 설정 완료

### 성능 고려사항
- 이미지 압축 전략 필요 (50MB 제한)
- 캐싱 전략 (drug_cache 테이블 활용)
- 오프라인 지원 계획

### CI/CD
- GitHub Actions 설정 예정
- 테스트 자동화 필요
- 배포 파이프라인 구축

## 🔍 검토 요청

### 결정 필요 사항

#### 1. 백엔드 통합 전략
- **A안**: Supabase 전면 사용 (권장) ✅
- **B안**: PillSnap API + Supabase 혼용

#### 2. 우선 적용 Phase Top 5
1. **라우트 상수 파일 생성** 🔴
2. **Drug Detail 구현** 🔴  
3. **카메라 실제 촬영** 🔴
4. **촬영 내역 저장** 🟡
5. **즐겨찾기 기능** 🟡

### QA 체크 항목

| 항목 | 상태 | 비고 |
|------|------|------|
| 문장 2줄 제한 | ✅ | ARB 파일 검증 |
| 접근성 (Semantics) | 🔄 | 부분 적용 |
| 다국어 (ko/en) | 🔄 | 한국어 우선 |
| 반응형 (태블릿) | ⏸️ | 추후 지원 |
| withOpacity 제거 | 🔄 | 검색 후 교체 |

---

**작성자**: Claude Code  
**검토 요청일**: 2025-09-06  
**다음 업데이트**: Phase 5 완료 시