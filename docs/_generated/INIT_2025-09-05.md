# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-05)

## 1. 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|---------|
| `signup-flow-fixes-2025-01-03.md` | `docs/` | 2025-09-05 | 회원가입, 이메일인증, 프로필설정 |
| `supabase_integration_2025-09-04.md` | `docs/` | 2025-09-04 | Supabase, 인증, 데이터베이스 |
| `supabase_schema_2025-09-04.md` | `docs/` | 2025-09-04 | 테이블구조, RLS, 마이그레이션 |
| `CLAUDE_MEMORY.md` | `docs/` | 2025-09-04 | 절대수칙, withOpacity금지, 즉시실행 |
| `camera_modifications_log.md` | `docs/` | 2025-09-03 | 카메라단순화, 줌컨트롤, iOS렌즈제거 |
| `IMAGE_OPTIMIZATION_GUIDE.md` | `docs/` | 2025-09-03 | 이미지전처리, EXIF, 검출률향상 |
| `API_INTEGRATION.md` | `docs/` | 2025-09-03 | API연동, pillsnap.co.kr, X-Api-Key |
| `ARCHITECTURE.md` | `docs/` | 2025-09-03 | Clean Architecture, Riverpod, go_router |
| `PROGRESS_2025-09-03.md` | `docs/` | 2025-09-03 | Phase진행상황, 70%완료 |
| `pillsnap_migration_plan_2025-09-03.md` | `docs/` | 2025-09-03 | 마이그레이션계획, Phase0-10 |

## 2. 아키텍처 규칙 (정규화 본문)

### 2.1 폴더 구조 표준

```
lib/
├── core/                       # 앱 전역 공통
│   ├── config/                 # 앱 설정 (AppConfig)
│   ├── error/                  # 예외/실패 타입
│   ├── network/                # API 클라이언트
│   ├── services/               # Supabase 등 서비스
│   ├── widgets/                # 공통 위젯
│   ├── utils/                  # 유틸리티
│   ├── router/                 # go_router 설정
│   │   ├── app_router.dart
│   │   └── route_paths.dart   # ⚠️ 필수: 라우트 상수
│   └── i18n/                   # 국제화 헬퍼
├── theme/                      # 디자인 토큰
│   ├── app_colors.dart
│   ├── app_typography.dart
│   ├── app_spacing.dart
│   └── app_theme.dart
├── features/                   # Feature-first 모듈
│   └── <feature>/
│       ├── data/              # 데이터 레이어
│       │   ├── datasources/
│       │   ├── models/        # freezed 모델
│       │   └── repositories/  # Repository 구현
│       ├── domain/            # 도메인 레이어
│       │   ├── entities/      # 순수 엔티티
│       │   ├── repositories/  # Repository 인터페이스
│       │   └── usecases/      # UseCase
│       └── presentation/      # 프레젠테이션 레이어
│           ├── controllers/   # Riverpod Notifier
│           ├── providers/     # Riverpod Provider
│           ├── pages/         # 화면
│           └── widgets/       # 화면별 위젯
├── l10n/                      # ARB 파일
│   ├── app_ko.arb            # 한국어 (템플릿)
│   └── app_en.arb            # 영어
└── main.dart
```

### 2.2 라우팅 규칙

- **필수**: `go_router` ^14.0.0 사용
- **필수**: 모든 경로는 `core/router/route_paths.dart` 상수 참조
- **구조**: `ShellRoute`로 메인 레이아웃 구성
- **가드**: `redirect`로 인증 체크 (Supabase 세션 기반)
- **네이밍**: 경로는 kebab-case, 이름은 camelCase
- **딥링크**: `app_links` 패키지 사용 (uni_links 대체)

### 2.3 상태관리 원칙

- **필수**: Riverpod 최신 API (`AsyncNotifier`, `Notifier`)
- **금지**: `StateProvider`, `StateNotifierProvider` (레거시)
- **패턴**: Feature별 Controller/Notifier 구현
- **네이밍**: `xxxNotifier`, `xxxControllerProvider`
- **Provider 위치**: `presentation/providers/` 디렉터리

### 2.4 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현(data)
- **UseCase**: 단일 책임, `call()` 메서드
- **Entity**: `freezed` 불변 객체
- **에러처리**: `Either<Failure, T>` 또는 `try-catch` 패턴
- **변환**: Model ↔ Entity는 `toEntity()`, `fromEntity()`

### 2.5 테마/토큰 시스템

- **절대금지**: 하드코딩된 색상/크기/간격
- **필수사용**: 
  - `AppColors.primary` (색상)
  - `AppSpacing.md` (간격) 
  - `AppTypography.h1` (텍스트스타일)
- **특별주의**: `withOpacity` 금지 → `withValues(alpha: value)` 사용
- **보더반경**: 일관된 12px 사용

### 2.6 국제화(i18n)

- **gen_l10n** 사용 (Flutter 내장)
- **설정파일**: `l10n.yaml` 필수
- **ARB 파일**: `lib/l10n/app_ko.arb` (템플릿)
- **문장제한**: 2줄 이내
- **키네이밍**: camelCase (예: `welcomeMessage`)
- **접근방식**: `AppLocalizations.of(context)!`

### 2.7 테스트/품질

- **구조**: `test/unit/`, `test/widget/`, `test/integration/`
- **lint**: `flutter analyze` 에러 0개 유지
- **format**: `flutter format . --set-exit-if-changed`
- **커버리지**: 핵심 비즈니스 로직 80% 이상
- **테스트 프레임워크**: `flutter_test`, `mocktail`

### 2.8 백엔드 연동

#### API 연동 (pillsnap.co.kr)
- **Base URL**: `https://api.pillsnap.co.kr`
- **인증**: `X-Api-Key` 헤더
- **API Key**: `YOUR_API_KEY_HERE`
- **환경변수**: `--dart-define`으로 주입

#### Supabase 연동
- **패키지**: `supabase_flutter` ^2.8.0
- **URL**: `https://dcpuiwszzyoojgikszaa.supabase.co`
- **ANON Key**: 환경변수로 주입
- **딥링크**: `app_links` 패키지 사용
- **테이블**: profiles, captures, favorites, medications 등 10개

## 3. 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| **Phase 진행률 불일치** | PROGRESS는 40%, CLAUDE_MEMORY는 35%, 실제는 70%? | 최신 상태 확인 후 통일 | 낮음 |
| **route_paths.dart 누락** | 문서에는 필수라고 하나 실제 파일 미확인 | 즉시 생성 필요 | **높음** |
| **API/Supabase 중복** | API와 Supabase 동시 사용 의도 불명확 | 역할 분리 명확화 (API: 약품분석, Supabase: 사용자데이터) | 중간 |
| **StateProvider 사용** | 일부 코드에서 레거시 API 사용 중 | AsyncNotifier로 점진적 마이그레이션 | 중간 |
| **withOpacity 잔존** | 여전히 일부 파일에 deprecated API 존재 | 전체 검색 후 일괄 교체 | 낮음 |
| **l10n 미설정** | ARB 파일은 있으나 l10n.yaml 누락 의심 | l10n.yaml 생성 및 gen-l10n 실행 | **높음** |
| **uni_links vs app_links** | 문서 간 패키지 불일치 | app_links로 통일 (최신 문서 기준) | 중간 |
| **프로필 테이블 PK** | id vs user_id 혼란 | user_id가 맞음 (Supabase 표준) | 중간 |

## 4. 실행 체크리스트

### 🔴 즉시 실행 (30분 이내)

- [ ] **route_paths.dart 생성** (S, 5분, 블로커: 없음)
  ```bash
  touch lib/core/router/route_paths.dart
  # 모든 라우트 상수 정의
  ```

- [ ] **l10n.yaml 생성** (S, 5분, 블로커: 없음)
  ```bash
  cat > l10n.yaml << EOF
  arb-dir: lib/l10n
  template-arb-file: app_ko.arb
  output-localization-file: app_localizations.dart
  EOF
  ```

- [ ] **withOpacity 전체 교체** (S, 10분, 블로커: 없음)
  ```bash
  grep -r "withOpacity" lib/ | wc -l
  # 발견 시: withOpacity(0.5) → withValues(alpha: 128)
  ```

- [ ] **환경변수 스크립트 생성** (S, 5분, 블로커: 없음)
  ```bash
  chmod +x scripts/run_with_supabase.sh
  # 이미 존재하면 스킵
  ```

- [ ] **ARB 파일 기본 구조** (S, 5분, 블로커: 없음)
  ```bash
  # lib/l10n/app_ko.arb에 최소 구조 확인
  flutter gen-l10n
  ```

### 🟡 오늘 내 실행 (2시간)

- [ ] **Drug Detail 구현 (Phase 5)** (L, 1시간, 블로커: API 연동)
  ```bash
  # lib/features/drug/presentation/pages/drug_detail_page.dart
  # 4개 탭: 성분, 효능·효과, 용법·용량, 주의사항
  ```

- [ ] **API 클라이언트 통합** (M, 30분, 블로커: 없음)
  ```bash
  # lib/core/network/pillsnap_api_client.dart
  # X-Api-Key 헤더 설정
  ```

- [ ] **StateProvider 마이그레이션** (M, 30분, 블로커: 없음)
  ```bash
  # 기존 StateProvider를 AsyncNotifier로 변경
  # 우선순위: auth > home > camera
  ```

### 🟢 이번 주 실행 (8시간)

- [ ] **Settings 기능 (Phase 6)** (M, 1시간, 블로커: 없음)
- [ ] **공통 컴포넌트 추출 (Phase 7)** (L, 2시간, 블로커: 없음)
- [ ] **라우팅 통합 (Phase 8)** (M, 1시간, 블로커: route_paths.dart)
- [ ] **i18n 완전 적용 (Phase 9)** (L, 2시간, 블로커: l10n.yaml)
- [ ] **최종 검증 (Phase 10)** (L, 2시간, 블로커: Phase 1-9 완료)

## 5. Phase 맵핑

| Phase | 계획 | 현재 코드 | Gap | 조치 |
|-------|------|-----------|-----|------|
| **Phase 0** | 기본 설정 | ✅ 완료 | route_paths.dart 누락 | 즉시 생성 |
| **Phase 1** | Auth 화면 | ✅ 완료 | Supabase 연동 추가됨 | 문서 업데이트 |
| **Phase 2** | Onboarding | ✅ 완료 | - | - |
| **Phase 3** | Home | ✅ 완료 | - | - |
| **Phase 4** | Camera | ✅ 완료 | 실제 촬영 미구현 | camera 패키지 구현 |
| **Phase 5** | Drug Detail | ⏸️ 대기 | - | **즉시 시작** |
| **Phase 6** | Settings | ⏸️ 대기 | notification_settings 테이블 추가 | UI 구현 |
| **Phase 7** | 공통 컴포넌트 | ⏸️ 대기 | 일부 진행 | 체계적 추출 |
| **Phase 8** | 라우팅 통합 | ⏸️ 대기 | go_router 사용 중 | 정리 필요 |
| **Phase 9** | i18n | ⏸️ 대기 | ARB 파일만 존재 | 설정 완료 |
| **Phase 10** | 최종 검증 | ⏸️ 대기 | - | 모든 Phase 후 |

## 6. 리스크/의존성

| 항목 | 설명 | 영향도 | 대응방안 |
|------|------|--------|----------|
| **route_paths.dart 누락** | 라우팅 상수 파일 없음 | **높음** | 즉시 생성 |
| **카메라 실제 구현** | camera 패키지 미연동 | **높음** | Phase 4 보완 |
| **API/Supabase 역할** | 중복/충돌 가능성 | 중간 | 명확한 분리 |
| **iOS 권한** | Info.plist 설정 | 중간 | 이미 완료 |
| **딥링크** | 이메일 인증 리다이렉트 | 중간 | app_links 설정 확인 |
| **성능** | 이미지 업로드/분석 | 낮음 | 압축/리사이징 |

## 7. 검토 요청

### A. 모순 해결안 선택

#### 1) **API vs Supabase 역할 분리**
- **A안**: API는 약품 분석만, Supabase는 모든 사용자 데이터 ✅ (권장)
- **B안**: API에 사용자 기능 추가, Supabase는 백업용

#### 2) **uni_links vs app_links**
- **A안**: app_links로 완전 교체 ✅ (권장)
- **B안**: uni_links 유지하며 문제 해결

### B. 우선 적용 Phase Top 5

1. **route_paths.dart 생성** - 모든 라우팅의 기반
2. **l10n 설정 완료** - 국제화 기반
3. **Phase 5 Drug Detail** - 핵심 기능
4. **withOpacity 교체** - 기술 부채 해결
5. **API 클라이언트 통합** - 백엔드 연동

### C. QA 체크 항목

| 항목 | 기준 | 현재 | 조치 |
|------|------|------|------|
| **문장 줄바꿈** | 2줄 이내 | 일부 초과 | ARB 키 분리 |
| **접근성** | Semantics 사용 | 미적용 | 점진적 추가 |
| **다국어** | ko/en 지원 | ko만 | en ARB 작성 |
| **반응형** | 다양한 화면 | 기본만 | MediaQuery 활용 |
| **하드코딩** | 0개 | 색상 일부 | 토큰 교체 |

---

**문서 버전**: 1.0.0  
**최종 수정일**: 2025-09-05  
**작성자**: Claude Code Assistant  
**검토 요청**: 위 선택지에서 A안 승인 요청드립니다.