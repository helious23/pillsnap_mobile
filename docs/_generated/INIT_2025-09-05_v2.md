# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-05)

## 1. 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|---------|
| `2025-09-05_implementation_guide.md` | `docs/` | 2025-09-05 | 기능구현가이드, 촬영내역, 즐겨찾기 |
| `2025-09-05_remaining_features_implementation.md` | `docs/` | 2025-09-05 | 남은기능명세, 우선순위매트릭스 |
| `CLAUDE_MEMORY.md` | `docs/` | 2025-09-05 | 절대수칙10개, withOpacity금지, 즉시실행 |
| `2025-01-03_signup-flow-fixes.md` | `docs/` | 2025-09-05 | 회원가입플로우, 이메일인증 |
| `2025-09-04_supabase_integration.md` | `docs/` | 2025-09-04 | Supabase연동, app_links, 딥링크 |
| `2025-09-04_supabase_schema.md` | `docs/` | 2025-09-04 | DB스키마, RLS정책, 8개추가테이블 |
| `camera_modifications_log.md` | `docs/` | 2025-09-03 | 카메라단순화, iOS렌즈제거 |
| `ARCHITECTURE.md` | `docs/` | 2025-09-03 | Clean Architecture, 레이어분리 |
| `2025-09-03_pillsnap_migration_plan.md` | `docs/` | 2025-09-03 | 10Phase계획, 14시간예상 |
| `2025-09-02_flutter_architecture_guide.md` | `docs/` | 2025-09-02 | Feature-first, 상세구현가이드 |

## 2. 아키텍처 규칙 (정규화 본문)

### 2.1 폴더 구조 표준

```
lib/
├── core/                       # 앱 전역 공통
│   ├── config/                 # AppConfig (--dart-define)
│   ├── error/                  # exceptions.dart, failures.dart
│   ├── network/                # api_client.dart
│   ├── services/               # supabase_service.dart
│   ├── widgets/                # 공통 위젯
│   ├── utils/                  # validators, formatters
│   ├── router/                 # ✅ 이미 구현
│   │   ├── app_router.dart    # go_router 설정
│   │   └── route_paths.dart   # 라우트 상수
│   └── i18n/                   # l10n_extensions.dart
├── theme/                      # 디자인 토큰
│   ├── app_colors.dart        # 색상 토큰
│   ├── app_typography.dart    # 타이포그래피
│   ├── app_spacing.dart       # 간격 시스템
│   └── app_theme.dart         # Material 테마
├── features/                   # Feature 모듈
│   └── <feature>/
│       ├── data/              
│       │   ├── datasources/
│       │   ├── models/        # freezed + json_serializable
│       │   └── repositories/  # Repository 구현체
│       ├── domain/            
│       │   ├── entities/      # 불변 엔티티
│       │   ├── repositories/  # Repository 인터페이스
│       │   └── usecases/      # 비즈니스 로직
│       └── presentation/      
│           ├── controllers/   # Riverpod AsyncNotifier/Notifier
│           ├── providers/     # Provider 정의
│           ├── pages/         # 화면
│           └── widgets/       # 화면별 위젯
├── l10n/                      # ✅ 이미 구현
│   ├── app_ko.arb            
│   └── app_en.arb            
└── main.dart
```

### 2.2 라우팅 규칙

- **프레임워크**: `go_router` ^14.0.0 ✅ 구현 완료
- **경로 상수**: `core/router/route_paths.dart` ✅ 구현 완료
- **구조**: `ShellRoute` 메인 레이아웃 ✅ 적용됨
- **인증 가드**: Supabase 세션 기반 `redirect` ✅ 구현됨
- **딥링크**: `app_links` 패키지 (uni_links 대체) ✅ 적용됨
- **네이밍**: 경로 kebab-case, 이름 camelCase

### 2.3 상태관리 원칙

- **필수**: Riverpod 2.5+ `AsyncNotifier`/`Notifier` 
- **금지**: `StateProvider`, `StateNotifierProvider` (레거시)
- **패턴**: Feature별 Controller/Notifier
- **네이밍**: `XxxNotifier`, `xxxControllerProvider`
- **위치**: `presentation/providers/` 또는 `presentation/controllers/`

### 2.4 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현(data)
- **UseCase**: 단일 책임, `call()` 메서드
- **Entity**: `freezed` 불변 객체 필수
- **에러처리**: `Either<Failure, T>` 또는 `try-catch`
- **변환**: `toEntity()`, `fromEntity()`, `toJson()`, `fromJson()`

### 2.5 테마/토큰 시스템

- **절대금지**: 하드코딩된 색상/크기/간격
- **필수사용**: 
  - `AppColors.primary`, `AppColors.textPrimary`
  - `AppSpacing.md`, `AppSpacing.lg`
  - `AppTypography.h1`, `AppTypography.body`
- **특별주의**: `withOpacity` 금지 → `withValues(alpha: value)` 사용
- **보더반경**: 일관된 12px (`BorderRadius.circular(12)`)

### 2.6 국제화(i18n)

- **설정**: `l10n.yaml` ✅ 구현 완료
- **ARB 파일**: `lib/l10n/app_ko.arb` (템플릿) ✅ 구현 완료
- **문장 제한**: 모든 문장 2줄 이내 필수
- **접근**: `AppLocalizations.of(context)!.키`

### 2.7 테스트 구조

```
test/
├── unit/              # UseCase, Repository 테스트
├── widget/            # 화면/위젯 테스트
└── integration/       # 라우팅/플로우 테스트
```

### 2.8 Supabase 통합

- **서비스**: `SupabaseService.instance` 싱글톤
- **인증**: 이메일/비밀번호, 이메일 인증 필수
- **비밀번호**: 8자+대문자+소문자+숫자+특수문자
- **테이블**: profiles, captures, favorites 등 8개 추가
- **실행**: `--dart-define` 환경변수 필수

## 3. 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| withOpacity 사용 여부 | CLAUDE_MEMORY 금지 명시 | 전체 검색 후 교체 | 낮음 (현재 0건) |
| StateProvider 사용 | migration_plan에 금지 명시 | AsyncNotifier 전환 | 중간 |
| 문장 2줄 제한 | i18n 규칙 | ARB 파일 전체 검토 | 낮음 |
| Route 상수화 | route_paths.dart 있음 | 하드코딩 경로 제거 | 낮음 |
| 테스트 구조 | test/ 폴더 미확인 | 구조 생성 필요 | 중간 |

## 4. 실행 체크리스트

### 즉시 실행 (S - 30분 이내)

- [x] `lib/core/router/route_paths.dart` 확인 ✅ 이미 있음
- [x] `l10n.yaml` 설정 확인 ✅ 이미 있음
- [ ] withOpacity 검색 및 교체 (0건이지만 재확인)
- [ ] Flutter analyze 실행 및 에러 해결
- [ ] pubspec.yaml scripts 섹션 추가

### 단기 작업 (M - 2시간)

- [ ] **촬영 내역 저장/조회** 구현
  - [ ] `CaptureRepository` 구현
  - [ ] Provider 설정
  - [ ] 홈 화면 연동
- [ ] **즐겨찾기 기능** 구현  
  - [ ] `FavoritesRepository` 구현
  - [ ] 약품 상세 페이지 버튼 추가
  - [ ] 즐겨찾기 목록 페이지
- [ ] StateProvider → AsyncNotifier 마이그레이션
- [ ] 테스트 폴더 구조 생성

### 장기 작업 (L - 1일 이상)

- [ ] **내가 먹는 약** 전체 구현
  - [ ] DB 스키마 구현
  - [ ] 약물 검색 API 연동
  - [ ] UI 페이지 3개 구현
- [ ] **복약 알림** 서비스
  - [ ] flutter_local_notifications 설정
  - [ ] 스케줄링 로직
  - [ ] 알림 UI
- [ ] **알러지 정보** 관리
  - [ ] 프로필 설정 UI
  - [ ] 약품 분석 시 체크

## 5. Phase 맵핑 (현재 vs 계획)

| Phase | 계획 | 현재 상태 | Gap |
|-------|------|----------|-----|
| Phase 0 | 기본 설정 | ✅ 완료 | - |
| Phase 1 | Auth 화면 | ✅ 완료 (Supabase 연동) | - |
| Phase 2 | Onboarding | ✅ 완료 | - |
| Phase 3 | Home 화면 | ✅ 완료 | 데이터 연동 필요 |
| Phase 4 | Camera 화면 | ✅ UI 완료 | 실제 촬영 구현 필요 |
| Phase 5 | Drug Detail | ⏸️ 대기 | 전체 구현 필요 |
| Phase 6 | Settings | ⏸️ 대기 | 전체 구현 필요 |
| Phase 7 | 공통 컴포넌트 | 🔄 부분 완료 | 추출 작업 필요 |
| Phase 8 | 라우팅 통합 | ✅ 완료 | - |
| Phase 9 | i18n 적용 | 🔄 부분 완료 | 전체 문자열 교체 |
| Phase 10 | 최종 검증 | ⏸️ 대기 | CI/CD 설정 필요 |

**진행률**: 약 65% 완료

## 6. 리스크/의존성

### 외부 의존성
- **Supabase**: 환경변수 설정 필수 (`--dart-define`)
- **API**: pillsnap.co.kr API 키 필요
- **카메라**: camera 패키지 실제 구현 대기

### 성능 리스크
- 이미지 업로드 크기 제한 (50MB)
- 촬영 내역 페이지네이션 필요
- 오프라인 모드 캐싱 전략

### 권한 이슈
- iOS: Info.plist 카메라/갤러리 권한
- Android: AndroidManifest.xml 권한

## 7. 검토 요청

### A. 결정 필요 사항

#### 1. 상태관리 마이그레이션
- **옵션 A**: 기존 StateProvider 유지하고 새 기능만 AsyncNotifier
- **옵션 B**: 전체 StateProvider → AsyncNotifier 즉시 전환
- **권고**: 옵션 A (점진적 마이그레이션)

#### 2. 테스트 전략
- **옵션 A**: 유닛 테스트 우선
- **옵션 B**: 통합 테스트 우선
- **권고**: 옵션 A (유닛 테스트 기반 구축)

### B. 우선 적용 Phase Top 5

1. **촬영 내역 저장/조회** - 핵심 기능, 난이도 낮음
2. **즐겨찾기 기능** - 사용자 요구 높음, 구현 간단
3. **내가 먹는 약 등록** - 핵심 기능, 중간 난이도
4. **알러지 정보 관리** - 안전 중요, 구현 간단
5. **Drug Detail 완성** - Phase 5 마무리

### C. QA 체크 항목

| 항목 | 체크 | 비고 |
|------|------|------|
| 문장 2줄 제한 | ⚠️ | ARB 파일 검토 필요 |
| 접근성 (Semantics) | ❌ | 구현 필요 |
| 다국어 (ko/en) | 🔄 | 부분 완료 |
| 반응형 (태블릿) | ❌ | 미구현 |
| withOpacity 금지 | ✅ | 0건 확인 |
| 하드코딩 색상 | ⚠️ | 재검토 필요 |

## 📋 즉시 실행 명령어

```bash
# 1. 린트 및 분석
flutter analyze

# 2. 코드 생성
flutter pub run build_runner build --delete-conflicting-outputs

# 3. 국제화 생성
flutter gen-l10n

# 4. Supabase 실행
flutter run \
  --dart-define=API_URL=https://api.pillsnap.co.kr \
  --dart-define=API_KEY=YOUR_API_KEY_HERE \
  --dart-define=SUPABASE_URL=https://dcpuiwszzyoojgikszaa.supabase.co \
  --dart-define=SUPABASE_ANON_KEY=YOUR_SUPABASE_ANON_KEY_HERE

# 5. 테스트 실행
flutter test

# 6. 빌드
flutter build apk
flutter build ios
```

---

*문서 생성: 2025-09-05*
*도구: Claude Code INIT*
*버전: v2*