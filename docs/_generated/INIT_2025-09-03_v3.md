# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-03 v3)

## 📊 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 주요 키워드 |
|--------|------|--------|-------------|
| IMAGE_OPTIMIZATION_GUIDE.md | `docs/` | 2025-09-03 14:46 | 이미지최적화, EXIF회전, 추론서버 |
| API_INTEGRATION.md | `docs/` | 2025-09-03 13:50 | API연동, X-Api-Key, pillsnap.co.kr |
| CLAUDE_MEMORY.md | `docs/` | 2025-09-03 11:05 | 절대수칙10개, withOpacity금지, 즉시실행 |
| INIT_2025-09-03_v2.md | `docs/_generated/` | 2025-09-03 11:00 | 아키텍처규칙, 충돌감지, Phase계획 |
| ARCHITECTURE.md | `docs/` | 2025-09-03 09:56 | Feature-first, Clean Architecture, Riverpod |
| PROGRESS_2025-09-03.md | `docs/` | 2025-09-03 09:54 | Phase 0-4 완료, 40% 진행 |
| flutter_architecture_guide | `docs/` | 2025-09-02 19:01 | 구현패턴, UseCase, 테스트전략 |
| pillsnap_migration_plan | `docs/` | 2025-09-03 00:55 | 10단계 Phase, 마이그레이션계획 |
| init-index.json | `docs/_generated/` | 2025-09-03 10:20 | 파일인덱스 |
| INIT_2025-09-03.md | `docs/_generated/` | 2025-09-03 10:20 | 초기온보딩문서 |

## 🏗️ 아키텍처 규칙 (정규화 본문)

### 📁 폴더 구조 표준

**Feature-first + Layered Architecture** 철저 준수

```
lib/
├── core/                       # 앱 전역 공통 요소
│   ├── error/                  # exceptions.dart, failures.dart
│   ├── network/                # api_client.dart (X-Api-Key 헤더)
│   ├── router/                 # go_router 필수
│   │   ├── app_router.dart    # GoRouter 구성
│   │   └── route_paths.dart   # 라우트 경로 상수
│   ├── widgets/                # 공통 UI 컴포넌트
│   └── utils/                  # validators, formatters, image_processor
├── theme/                      # 디자인 토큰 시스템
│   ├── app_theme.dart         # Material 3 테마
│   ├── app_colors.dart        # 색상 토큰
│   ├── app_typography.dart    # Inter 폰트 타이포
│   ├── app_spacing.dart       # 간격 시스템
│   └── app_dimensions.dart    # 크기, 반경
├── features/                   # 기능별 모듈
│   └── [feature_name]/
│       ├── data/
│       │   ├── datasources/   # Remote/Local 데이터소스
│       │   ├── models/        # freezed + json_serializable
│       │   └── repositories/  # Repository 구현체
│       ├── domain/
│       │   ├── entities/      # freezed 불변 객체
│       │   ├── repositories/  # 추상 인터페이스
│       │   └── usecases/      # Either<Failure, T>
│       └── presentation/
│           ├── controllers/   # AsyncNotifier/Notifier
│           ├── pages/         # 화면 위젯
│           └── widgets/       # 컴포넌트
├── l10n/                      # 국제화 파일
│   ├── app_ko.arb            # 한국어 (문장 2줄 제한)
│   └── app_en.arb            # 영어
└── main.dart                  # 진입점
```

### 🚦 라우팅 규칙

- **필수 사용**: go_router v14.0.0
- **경로 관리**: `route_paths.dart` 상수만 참조
- **ShellRoute**: 하단 네비게이션 구현
- **금지**: Navigator.pushNamed, 하드코딩 경로

### 🎯 상태관리 규칙

**Riverpod v2.5.0 최신 API만 사용**

```dart
// ✅ 허용
AsyncNotifier, Notifier, FutureProvider, StreamProvider

// ❌ 금지
StateProvider, StateNotifierProvider, ChangeNotifier
```

### 🏛️ 도메인 레이어 규칙

1. **Entity**: freezed로 불변 객체 생성
2. **Repository**: 도메인에 추상 인터페이스
3. **UseCase**: `Either<Failure, T>` 반환
4. **변환**: Model ↔ Entity 간 toEntity/fromEntity

### 🎨 테마/토큰 시스템

**하드코딩 절대 금지**

```dart
// ✅ 올바른 사용
color: AppColors.primary
spacing: AppSpacing.md
radius: AppDimensions.radiusMedium

// ❌ 금지
color: Color(0xFF1A73E8)  // 하드코딩
withOpacity(0.5)           // withValues(alpha: 128) 사용
```

### 🌍 국제화(i18n) 규칙

- **모든 텍스트**: ARB 파일 경유
- **문장 길이**: 2줄 이내 제한
- **키 네이밍**: `feature_component_description`
- **변수 처리**: `{variable}` 형식

## ⚠️ 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| **withOpacity 사용** | 여러 파일에서 deprecated API 사용 중 | `withValues(alpha:)` 일괄 교체 | **높음** - 빌드 경고 |
| **StateProvider 잔존** | 레거시 Riverpod API 일부 존재 | AsyncNotifier로 마이그레이션 | **중간** |
| **route_paths.dart 누락** | 라우트 경로 하드코딩 발견 | 상수 파일 생성 및 적용 | **낮음** |
| **ARB 파일 미생성** | l10n 폴더 및 ARB 파일 없음 | 즉시 생성 및 flutter gen-l10n | **높음** |
| **API 엔드포인트 분산** | API URL이 여러 곳에 하드코딩 | api_endpoints.dart 통합 | **중간** |
| **이미지 전처리 누락** | 카메라 촬영 후 EXIF 미처리 | image_processor.dart 구현 | **높음** |

## ✅ 실행 체크리스트

### 🚨 즉시 실행 (30분 이내)

| 작업 | 명령/경로 | 난이도 | 소요 | 블로커 |
|------|-----------|--------|------|---------|
| **ARB 파일 생성** | `mkdir -p lib/l10n && touch lib/l10n/app_{ko,en}.arb` | S | 2분 | 없음 |
| **l10n.yaml 생성** | 프로젝트 루트에 설정 파일 작성 | S | 3분 | 없음 |
| **flutter gen-l10n** | 국제화 코드 생성 | S | 2분 | ARB 파일 |
| **withOpacity 교체** | `grep -r "withOpacity" lib/` 후 일괄 수정 | S | 10분 | 없음 |
| **route_paths.dart** | `lib/core/router/route_paths.dart` 생성 | S | 5분 | 없음 |
| **API 키 설정** | `.env.local` 생성, X-Api-Key 설정 | S | 3분 | API 키 필요 |
| **이미지 전처리** | `lib/core/utils/image_processor.dart` | M | 15분 | 없음 |

### 📦 Phase 5-6 구현 (1-2시간)

| 작업 | 설명 | 난이도 | 소요 | 블로커 |
|------|------|--------|------|---------|
| **Drug Detail 구현** | features/drug 모듈 완성 | M | 1시간 | API 스펙 |
| **Settings 구현** | features/settings 모듈 | S | 30분 | 없음 |
| **API 연동** | pillsnap.co.kr 연결 | M | 45분 | API 키 |
| **이미지 업로드** | 카메라 → API 전송 | M | 30분 | 전처리 |

### 🔧 품질 개선 (2-3시간)

| 작업 | 설명 | 난이도 | 소요 | 블로커 |
|------|------|--------|------|---------|
| **StateProvider 제거** | AsyncNotifier 마이그레이션 | M | 1시간 | 없음 |
| **공통 컴포넌트 추출** | core/widgets로 이동 | M | 1시간 | 없음 |
| **테스트 작성** | Unit/Widget 테스트 | L | 2시간 | 없음 |
| **CI/CD 설정** | GitHub Actions | M | 30분 | 없음 |

## 📈 Phase 맵핑

| Phase | 계획 상태 | 실제 상태 | Gap | 조치 필요 |
|-------|-----------|-----------|-----|-----------|
| Phase 0 | 기본 설정 | ✅ 완료 | 없음 | - |
| Phase 1 | Auth 화면 | ✅ 완료 | 없음 | - |
| Phase 2 | Onboarding | ✅ 완료 | 없음 | - |
| Phase 3 | Home | ✅ 완료 | 없음 | - |
| Phase 4 | Camera | ✅ 완료 | EXIF 처리 누락 | image_processor 구현 |
| Phase 5 | Drug Detail | 🔄 대기 | 미구현 | **즉시 시작** |
| Phase 6 | Settings | 🔄 대기 | 미구현 | Phase 5 후 진행 |
| Phase 7 | 공통 컴포넌트 | 🔄 대기 | 부분 완료 | 추출 작업 필요 |
| Phase 8 | 라우팅 통합 | 🔄 대기 | route_paths 누락 | 상수 파일 생성 |
| Phase 9 | i18n | 🔄 대기 | ARB 파일 없음 | **즉시 생성** |
| Phase 10 | 최종 검증 | 🔄 대기 | - | 전체 완료 후 |

## 🚨 리스크/의존성

| 항목 | 리스크 레벨 | 영향 범위 | 완화 방안 |
|------|-------------|-----------|-----------|
| **ARB 파일 누락** | 🔴 높음 | 전체 앱 | 즉시 생성 및 텍스트 마이그레이션 |
| **API 키 미설정** | 🔴 높음 | API 기능 | .env.local 설정 |
| **EXIF 회전 미처리** | 🟡 중간 | 카메라 기능 | image_processor 구현 |
| **withOpacity 사용** | 🟡 중간 | UI 렌더링 | 일괄 교체 스크립트 |
| **StateProvider 사용** | 🟢 낮음 | 상태 관리 | 점진적 마이그레이션 |

## 📋 검토 요청

### A. 결정 필요 사항

1. **API 환경 선택**
   - ✅ A안: Production API (https://api.pillsnap.co.kr) 직접 사용
   - ⬜ B안: 개발용 Mock 서버 구축 후 연동

2. **이미지 전송 방식**
   - ⬜ A안: FormData로 파일 직접 전송
   - ✅ B안: Base64 인코딩 후 JSON 전송 (추천)

3. **i18n 우선순위**
   - ✅ A안: 한국어 우선, 영어는 추후
   - ⬜ B안: 한/영 동시 지원

### B. 우선 적용 Phase Top 5

1. **Phase 5**: Drug Detail 구현 (1시간)
2. **Phase 9**: i18n ARB 파일 생성 (30분)
3. **Phase 8**: route_paths.dart 생성 (15분)
4. **API 연동**: X-Api-Key 설정 (30분)
5. **이미지 전처리**: EXIF 회전 처리 (30분)

### C. QA 체크 항목

| 검사 항목 | 현재 상태 | 목표 |
|-----------|-----------|------|
| **문장 줄바꿈** | 일부 3줄 이상 | 모든 텍스트 2줄 이내 |
| **접근성** | 기본 수준 | Semantics 추가 |
| **다국어** | 하드코딩 | ARB 파일 100% |
| **반응형** | 부분 지원 | 전체 화면 대응 |
| **withOpacity** | 사용 중 | withValues 전환 |

---

*문서 버전: v3*  
*작성일: 2025-09-03*  
*다음 업데이트: Phase 5 완료 시*