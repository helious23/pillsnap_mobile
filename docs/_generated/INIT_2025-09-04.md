# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-04)

## 1. 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|---------|
| `camera_modifications_log.md` | `docs/` | 2025-09-03 | 카메라, 단순화, 줌컨트롤 |
| `CLAUDE_MEMORY.md` | `docs/` | 2025-09-03 | 절대수칙, 즉시실행, withOpacity |
| `IMAGE_OPTIMIZATION_GUIDE.md` | `docs/` | 2025-09-03 | 이미지전처리, EXIF, 검출률 |
| `API_INTEGRATION.md` | `docs/` | 2025-09-03 | API연동, pillsnap.co.kr, X-Api-Key |
| `ARCHITECTURE.md` | `docs/` | 2025-09-03 | Clean Architecture, 레이어, Riverpod |
| `PROGRESS_2025-09-03.md` | `docs/` | 2025-09-03 | Phase진행, 40%완료, Phase5대기 |
| `flutter_architecture_guide_2025-09-02.md` | `docs/` | 2025-09-03 | 완전가이드, 코드예시, 체크리스트 |
| `pillsnap_migration_plan_2025-09-03.md` | `docs/` | 2025-09-03 | 마이그레이션계획, Phase0-10, 14시간 |
| `INIT_2025-09-03_v3.md` | `docs/_generated/` | 이전버전 | 기존온보딩 |
| `init-index-v3.json` | `docs/_generated/` | 이전버전 | 인덱스 |

## 2. 아키텍처 규칙 (정규화 본문)

### 2.1 폴더 구조 표준

```
lib/
├── core/                       # 앱 전역 공통
│   ├── error/                  # 예외/실패 타입
│   ├── network/                # API 클라이언트
│   ├── widgets/                # 공통 위젯
│   ├── utils/                  # 유틸리티
│   ├── router/                 # go_router 설정
│   │   ├── app_router.dart
│   │   └── route_paths.dart   # ⚠️ 필수: 라우트 상수
│   └── i18n/                   # 국제화 헬퍼
├── theme/                      # 디자인 토큰
│   ├── app_colors.dart
│   ├── app_typography.dart
│   ├── app_spacing.dart
│   └── app_theme.dart
├── features/                   # Feature-first 모듈
│   └── <feature>/
│       ├── data/              # 데이터 레이어
│       │   ├── datasources/
│       │   ├── models/        # freezed 모델
│       │   └── repositories/  # Repository 구현
│       ├── domain/            # 도메인 레이어
│       │   ├── entities/      # 순수 엔티티
│       │   ├── repositories/  # Repository 인터페이스
│       │   └── usecases/      # UseCase
│       └── presentation/      # 프레젠테이션 레이어
│           ├── controllers/   # Riverpod Notifier
│           ├── pages/         # 화면
│           └── widgets/       # 화면별 위젯
├── l10n/                      # ARB 파일
│   ├── app_ko.arb
│   └── app_en.arb
└── main.dart
```

### 2.2 라우팅 규칙

- **필수**: `go_router` 사용
- **필수**: 모든 경로는 `core/router/route_paths.dart` 상수 참조
- **구조**: ShellRoute로 메인 레이아웃 구성
- **가드**: redirect로 인증 체크
- **네이밍**: 경로는 kebab-case, 이름은 camelCase

### 2.3 상태관리 원칙

- **필수**: Riverpod 최신 API (`AsyncNotifier`, `Notifier`)
- **금지**: `StateProvider`, `StateNotifierProvider` (레거시)
- **패턴**: Feature별 Controller/Notifier 구현
- **네이밍**: `xxxNotifier`, `xxxControllerProvider`

### 2.4 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현(data)
- **UseCase**: 단일 책임, call() 메서드
- **Entity**: freezed 불변 객체
- **에러처리**: `Either<Failure, T>` 패턴
- **변환**: Model ↔ Entity는 toEntity(), fromEntity()

### 2.5 테마/토큰 시스템

- **절대금지**: 하드코딩된 색상/크기/간격
- **필수사용**: 
  - `AppColors.primary` (색상)
  - `AppSpacing.md` (간격)
  - `AppTypography.h1` (텍스트스타일)
- **특별주의**: `withOpacity` 금지 → `withValues(alpha: value)` 사용

### 2.6 국제화(i18n)

- **gen_l10n** 사용 (flutter 내장)
- **ARB 파일**: `lib/l10n/app_ko.arb` (템플릿)
- **문장제한**: 2줄 이내
- **키네이밍**: camelCase (예: `welcomeMessage`)

### 2.7 테스트/품질

- **구조**: `test/unit/`, `test/widget/`, `test/integration/`
- **lint**: `flutter analyze` 에러 0개 유지
- **format**: `flutter format . --set-exit-if-changed`
- **coverage**: 핵심 로직 80% 이상

## 3. 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| **route_paths.dart 누락** | ARCHITECTURE.md는 필수라고 명시, 실제 없음 | 즉시 생성 | 🔴 높음 |
| **l10n 설정 미완료** | ARB 파일 없음, l10n.yaml 없음 | Phase 9 전에 설정 | 🟡 중간 |
| **API 키 하드코딩** | API_INTEGRATION.md에 실제 키 노출 | 환경변수로 이동 | 🔴 높음 |
| **StateProvider 사용중** | CLAUDE_MEMORY는 금지, 일부 코드에 남음 | 점진적 마이그레이션 | 🟡 중간 |
| **이미지 전처리 미적용** | IMAGE_OPTIMIZATION_GUIDE 코드 미적용 | preprocessImageForInference 즉시 적용 | 🔴 높음 |
| **Phase 진행 불일치** | PROGRESS는 Phase 4 완료, migration_plan은 Phase 0 진행중 | 현황 업데이트 | 🟢 낮음 |
| **카메라 실제 구현 누락** | UI만 완성, camera 패키지 미연동 | Phase 5와 함께 구현 | 🔴 높음 |

## 4. 실행 체크리스트

### 🔴 즉시 조치 (30분 이내)

| 할 일 | 난이도 | 소요 | 블로커 | 담당 |
|-------|--------|------|--------|------|
| ☐ `route_paths.dart` 파일 생성 | S | 5분 | 없음 | TBA |
| ☐ ARB 파일 생성 (`lib/l10n/app_{ko,en}.arb`) | S | 5분 | 없음 | TBA |
| ☐ `l10n.yaml` 설정 파일 생성 | S | 3분 | 없음 | TBA |
| ☐ `withOpacity` → `withValues` 전체 교체 | S | 10분 | 없음 | TBA |
| ☐ `.env.local` 생성 및 API 키 이동 | S | 5분 | 없음 | TBA |

### 🟡 긴급 작업 (오늘 중)

| 할 일 | 난이도 | 소요 | 블로커 | 담당 |
|-------|--------|------|--------|------|
| ☐ 이미지 전처리 함수 적용 (`preprocessImageForInference`) | M | 30분 | 없음 | TBA |
| ☐ Phase 5: Drug Detail 구현 시작 | L | 2시간 | API 연동 | TBA |
| ☐ Camera 실제 촬영 기능 구현 | L | 2시간 | 권한 처리 | TBA |
| ☐ API 클라이언트 모듈 생성 (`core/network/api_client.dart`) | M | 1시간 | 없음 | TBA |

### 🟢 계획된 작업 (이번 주)

| 할 일 | 난이도 | 소요 | 블로커 | 담당 |
|-------|--------|------|--------|------|
| ☐ Phase 6: Settings 화면 | M | 30분 | 없음 | TBA |
| ☐ Phase 7: 공통 컴포넌트 추출 | M | 1시간 | 없음 | TBA |
| ☐ Phase 8: 라우팅 통합 완료 | M | 1시간 | 없음 | TBA |
| ☐ Phase 9: i18n 전체 적용 | L | 2시간 | ARB 파일 | TBA |
| ☐ Phase 10: 최종 검증 | L | 2시간 | 모든 Phase | TBA |

## 5. Phase 맵핑

| Phase | 계획 상태 | 실제 상태 | Gap | 조치 |
|-------|----------|----------|-----|------|
| Phase 0 | 기본 설정 | ✅ 완료 | 없음 | - |
| Phase 1 | Auth 화면 | ✅ 완료 | 없음 | - |
| Phase 2 | Onboarding | ✅ 완료 | 없음 | - |
| Phase 3 | Home + Nav | ✅ 완료 | 없음 | - |
| Phase 4 | Camera | ✅ UI 완료 | 🔴 실제 촬영 미구현 | 즉시 구현 |
| Phase 5 | Drug Detail | 🔄 대기 | 🔴 미시작 | 오늘 시작 |
| Phase 6 | Settings | 🔄 대기 | 미시작 | 이번 주 |
| Phase 7 | 컴포넌트 | 🔄 대기 | 미시작 | 이번 주 |
| Phase 8 | 라우팅 | 🔄 대기 | 부분 완료 | 통합 필요 |
| Phase 9 | i18n | 🔄 대기 | 🔴 설정 없음 | ARB 생성 후 |
| Phase 10 | 검증 | 🔄 대기 | 미시작 | 모든 Phase 후 |

**전체 진행률**: 40% → 실질 35% (카메라/API 미구현)

## 6. 리스크/의존성

| 리스크 | 영향도 | 발생확률 | 대응방안 |
|--------|--------|----------|----------|
| API 서버 불안정 | 🔴 높음 | 중간 | 로컬 모킹, 재시도 로직 |
| 이미지 검출률 저하 | 🔴 높음 | 높음 | 전처리 최적화 필수 |
| iOS 카메라 권한 | 🟡 중간 | 낮음 | Info.plist 설정 확인 |
| 다국어 키 누락 | 🟡 중간 | 높음 | 개발 중 지속 체크 |
| 메모리 누수 | 🟡 중간 | 중간 | Provider 생명주기 관리 |
| withOpacity 잔존 | 🟢 낮음 | 높음 | 전체 검색/교체 |

## 7. 검토 요청

### A. 모순 해결안 선택

**이슈: StateProvider 사용 정책**
- **A안**: 즉시 모든 StateProvider를 AsyncNotifier로 교체 (2시간)
- **B안**: 새 코드만 AsyncNotifier, 기존 코드는 점진적 교체 ✅ (권장)

**이슈: 카메라 구현 시점**
- **A안**: Phase 5 전에 카메라 완성 ✅ (권장)
- **B안**: Phase 5와 병행하여 구현

### B. 우선 적용 Phase Top 5

1. **route_paths.dart 생성** - 라우팅 기반
2. **ARB/l10n 설정** - 모든 텍스트 의존
3. **이미지 전처리** - 핵심 기능
4. **Phase 5 Drug Detail** - 다음 마일스톤
5. **API 연동** - 실제 서비스

### C. QA 체크 항목

| 항목 | 현재 | 목표 | 체크 |
|------|------|------|------|
| 문장 줄바꿈 | 일부 3줄 이상 | 2줄 이내 | ☐ |
| 접근성 | Semantics 부분적용 | 전체 적용 | ☐ |
| 다국어 | 하드코딩 | ARB 100% | ☐ |
| 반응형 | 기본 대응 | 태블릿 지원 | ☐ |
| withOpacity | 일부 사용중 | 0개 | ☐ |
| 테스트 | 기본 테스트만 | 80% 커버리지 | ☐ |

---

**문서 버전**: 4.0.0  
**작성일**: 2025-09-04  
**작성자**: Claude Code  
**검토 요청**: 위 선택지와 체크리스트를 확인하고 진행 방향을 결정해 주세요.

## 🚀 바로 실행 가능한 명령어

```bash
# 1. 필수 파일 생성
mkdir -p lib/l10n lib/core/router
touch lib/core/router/route_paths.dart
touch lib/l10n/app_ko.arb lib/l10n/app_en.arb
touch l10n.yaml

# 2. l10n.yaml 내용 설정
echo "arb-dir: lib/l10n
template-arb-file: app_ko.arb
output-localization-file: app_localizations.dart" > l10n.yaml

# 3. withOpacity 검색 및 수정 필요 파일 확인
grep -r "withOpacity" lib/ --include="*.dart"

# 4. 환경 변수 설정
echo "FLUTTER_API_URL=https://api.pillsnap.co.kr
FLUTTER_API_KEY=YOUR_API_KEY_HERE" > .env.local

# 5. 코드 생성 및 분석
flutter pub run build_runner build --delete-conflicting-outputs
flutter gen-l10n
flutter analyze
```