# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-03)

## 1. 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 크기 | 키워드 |
|--------|------|--------|------|---------|
| ARCHITECTURE.md | `docs/ARCHITECTURE.md` | 2025-09-03 09:56 | 11,481 | architecture, 폴더구조, 라우팅, 상태관리, 테마, 테스트 |
| PROGRESS_2025-09-03.md | `docs/PROGRESS_2025-09-03.md` | 2025-09-03 09:54 | 6,482 | phase, 진행상황, 완료작업, 이슈해결 |
| CLAUDE_MEMORY.md | `docs/CLAUDE_MEMORY.md` | 2025-09-03 08:17 | 1,243 | 절대수칙, 즉시실행명령, 우선순위 |
| INIT_2025-09-03.md | `docs/_generated/INIT_2025-09-03.md` | 2025-09-03 08:16 | 12,655 | 아키텍처규칙, 충돌리포트, 체크리스트 |
| flutter_architecture_guide | `docs/flutter_architecture_guide_2025-09-02.md` | 2025-09-03 08:01 | 26,098 | clean architecture, 레이어, 구현패턴, 코드예시 |
| pillsnap_migration_plan | `docs/pillsnap_migration_plan_2025-09-03.md` | 2025-09-03 00:55 | 14,568 | migration, phase계획, 체크리스트, 예상소요시간 |

## 2. 아키텍처 규칙 (정규화 본문)

### 📁 폴더 구조 표준

**Feature-first + Layered Architecture** 철저 준수

```
lib/
├── core/                       # 앱 전역 공통
│   ├── error/                 # 커스텀 예외, Failure 타입
│   ├── network/               # API 클라이언트, 엔드포인트
│   ├── router/                # go_router 설정
│   │   ├── app_router.dart   # GoRouter 인스턴스
│   │   └── route_paths.dart  # 라우트 경로 상수
│   ├── widgets/               # 공통 UI 컴포넌트
│   └── utils/                 # 헬퍼 함수, 상수
├── theme/                     # 디자인 시스템
│   ├── app_theme.dart        # Material Theme 구성
│   ├── app_colors.dart       # 색상 토큰
│   ├── app_typography.dart   # 타이포그래피 토큰
│   ├── app_spacing.dart      # 간격 시스템
│   └── app_dimensions.dart   # 크기, 반경 토큰
├── features/                  # 기능별 모듈
│   └── [feature_name]/
│       ├── data/
│       │   ├── datasources/  # Remote/Local 데이터소스
│       │   ├── models/       # DTO (freezed + json_serializable)
│       │   └── repositories/ # Repository 구현체
│       ├── domain/
│       │   ├── entities/     # 비즈니스 엔티티
│       │   ├── repositories/ # Repository 추상 인터페이스
│       │   └── usecases/     # 비즈니스 유스케이스
│       └── presentation/
│           ├── controllers/   # Riverpod Notifier/AsyncNotifier
│           ├── pages/        # 화면 위젯
│           └── widgets/      # 화면별 컴포넌트
├── l10n/                      # 국제화 리소스
│   ├── app_ko.arb            # 한국어
│   └── app_en.arb            # 영어
└── main.dart                  # 앱 진입점
```

### 🚦 라우팅 규칙

**go_router 전면 채택**

- 모든 경로는 `route_paths.dart`에 상수로 정의
- ShellRoute로 하단 네비게이션 구현
- 라우트 가드는 redirect 콜백에서 처리
- 네임드 라우트 사용 (path + name 모두 정의)
- Navigator.pushNamed 사용 금지

```dart
// core/router/route_paths.dart
class RoutePaths {
  static const splash = '/splash';
  static const login = '/auth/login';
  static const emailInput = '/auth/email';
  static const codeVerification = '/auth/code';
  static const passwordSetup = '/auth/password';
  static const onboarding = '/onboarding';
  static const home = '/home';
  static const camera = '/camera';
  static const drugDetail = '/drug/:id';
  static const settings = '/settings';
}
```

### 🎯 상태관리 규칙

**Riverpod 최신 API만 사용**

- **필수**: AsyncNotifier, Notifier, FutureProvider, StreamProvider
- **금지**: StateProvider, ChangeNotifierProvider, StateNotifierProvider
- **필수**: `@riverpod` 어노테이션 + 코드 생성
- **금지**: 위젯 내 Provider 직접 생성
- **필수**: ref.watch()는 build 메서드 내에서만

```dart
// ✅ 올바른 사용
@riverpod
class AuthController extends _$AuthController {
  @override
  FutureOr<AuthState> build() => const AuthState.initial();
  
  Future<void> signIn(String email, String password) async {
    state = const AsyncLoading();
    final result = await ref.read(signInUseCaseProvider)(
      SignInParams(email, password),
    );
    state = result.fold(
      (failure) => AsyncError(failure, StackTrace.current),
      (user) => AsyncData(AuthState.authenticated(user)),
    );
  }
}
```

### 🏛️ 도메인 규칙

**Clean Architecture 엄격 준수**

1. **Entity**: freezed 불변 객체, 비즈니스 규칙 포함
2. **Repository Interface**: 추상 클래스, domain 레이어 위치
3. **UseCase**: 단일 책임, Either<Failure, T> 반환
4. **Model↔Entity 변환**: toEntity(), fromEntity() 메서드

```dart
// domain/entities/user.dart
@freezed
class User with _$User {
  const factory User({
    required String id,
    required String email,
    required String name,
    DateTime? createdAt,
  }) = _User;
}

// domain/repositories/auth_repository.dart
abstract class AuthRepository {
  Future<Either<Failure, User>> signIn(String email, String password);
  Future<Either<Failure, void>> signOut();
}

// domain/usecases/sign_in.dart
class SignInUseCase {
  final AuthRepository _repository;
  
  SignInUseCase(this._repository);
  
  Future<Either<Failure, User>> call(SignInParams params) async {
    if (!EmailValidator.validate(params.email)) {
      return Left(ValidationFailure('올바른 이메일 형식이 아닙니다'));
    }
    return await _repository.signIn(params.email, params.password);
  }
}
```

### 🎨 테마/토큰 시스템

**하드코딩 절대 금지**

- 색상: `AppColors.primary`, `AppColors.textPrimary`
- 타이포: `AppTextStyles.headline1`, `AppTextStyles.body1`
- 간격: `AppSpacing.xs`, `AppSpacing.sm`, `AppSpacing.md`
- 반경: `AppDimensions.radiusSmall`, `AppDimensions.radiusMedium`
- elevation: `AppDimensions.elevationSmall`

```dart
// ❌ 절대 금지
Container(
  color: Color(0xFF1A73E8),
  padding: EdgeInsets.all(16),
  child: Text('안녕', style: TextStyle(fontSize: 16)),
)

// ✅ 필수
Container(
  color: AppColors.primary,
  padding: EdgeInsets.all(AppSpacing.md),
  child: Text('안녕', style: AppTextStyles.body1),
)
```

### 🌍 국제화(i18n) 규칙

**flutter gen-l10n 사용**

- 모든 텍스트는 ARB 파일 경유
- **문장 2줄 제한** 철저 준수
- 키 네이밍: `feature_component_description`
- 변수는 `{variable}` 형식

```json
// l10n/app_ko.arb
{
  "auth_login_title": "로그인",
  "auth_login_welcomeMessage": "PillSnap에 오신 것을\n환영합니다!",
  "@auth_login_welcomeMessage": {
    "description": "로그인 화면 환영 메시지 (2줄)"
  },
  "home_recentCapture_count": "최근 촬영: {count}개",
  "@home_recentCapture_count": {
    "placeholders": {
      "count": { "type": "int" }
    }
  }
}
```

### 🧪 테스트/품질 구조

```
test/
├── unit/                # UseCase, Repository 테스트
│   └── features/
│       └── auth/
│           ├── domain/
│           └── data/
├── widget/              # 화면, 위젯 테스트
│   └── features/
│       └── auth/
│           └── presentation/
└── integration/         # 통합, E2E 테스트
    └── auth_flow_test.dart
```

**필수 검증 항목**:
- flutter analyze 에러 0개
- flutter format 적용
- 테스트 커버리지 80% 이상
- const 생성자 최대 활용

## 3. 충돌·중복·누락 리포트

| 이슈 | 현재 상태 | 권고안 | 리스크 | 우선순위 |
|------|-----------|---------|---------|----------|
| **Phase 완료 불일치** | PROGRESS: Phase 0-4 완료 / Migration Plan: Phase 0 진행중 | PROGRESS 문서 기준으로 Phase 5부터 진행 | 낮음 | 높음 |
| **파일명 규칙** | 일부 snake_case 전환 완료 | 모든 파일 검증 필요 | 낮음 | 중간 |
| **withOpacity 사용** | deprecated API 일부 교체 | 전체 코드베이스 검색 후 withValues(alpha:) 교체 | 낮음 | 낮음 |
| **Provider 패턴 혼재** | AsyncNotifier와 StateProvider 혼용 | StateProvider 제거, AsyncNotifier 통일 | 중간 | 높음 |
| **ARB 파일 미존재** | l10n 폴더 미생성 | ARB 파일 생성 및 gen-l10n 설정 | 중간 | 높음 |
| **테스트 구조 미비** | 기본 위젯 테스트만 존재 | 3단계 테스트 구조 수립 | 낮음 | 중간 |

## 4. 실행 체크리스트

### 🚀 즉시 실행 (30분 이내)

| 작업 | 명령/경로 | 난이도 | 소요 | 상태 |
|------|-----------|--------|------|------|
| ARB 파일 생성 | `mkdir -p lib/l10n && touch lib/l10n/app_{ko,en}.arb` | S | 2분 | ⏳ |
| l10n 설정 추가 | `pubspec.yaml`에 `generate: true` 추가 | S | 3분 | ⏳ |
| gen-l10n 실행 | `flutter gen-l10n` | S | 2분 | ⏳ |
| withOpacity 전체 교체 | `grep -r "withOpacity" lib/` 후 수정 | S | 10분 | ⏳ |
| StateProvider 제거 | Provider 패턴 통일 | M | 15분 | ⏳ |
| 테스트 폴더 구조 생성 | `mkdir -p test/{unit,widget,integration}` | S | 3분 | ⏳ |

### 📱 Phase 5: Drug Detail (다음 단계, 1시간)

| 작업 | 세부 내용 | 난이도 | 소요 | 블로커 |
|------|-----------|--------|------|---------|
| Drug Entity 생성 | `features/drug/domain/entities/drug.dart` | S | 10분 | freezed |
| Drug Repository Interface | `domain/repositories/drug_repository.dart` | S | 10분 | - |
| GetDrugDetail UseCase | `domain/usecases/get_drug_detail.dart` | M | 15분 | repository |
| Drug Model | `data/models/drug_model.dart` | M | 15분 | json_serializable |
| DrugDetailPage UI | `presentation/pages/drug_detail_page.dart` | M | 20분 | assets 확인 |

### 🔧 Phase 6-10: 나머지 구현

| Phase | 내용 | 예상 소요 | 우선순위 | 의존성 |
|-------|------|-----------|----------|---------|
| Phase 6 | Settings 화면 | 30분 | 중간 | - |
| Phase 7 | 공통 컴포넌트 추출 | 1시간 | 높음 | theme 토큰 |
| Phase 8 | 라우팅 통합 완성 | 1시간 | 높음 | 모든 화면 완료 |
| Phase 9 | i18n 전체 적용 | 1시간 | 높음 | ARB 파일 |
| Phase 10 | 최종 검증 및 최적화 | 1시간 | 중간 | 모든 Phase |

## 5. Phase 맵핑

### 현재 완료 상태 (PROGRESS 기준)

| Phase | 계획 | 실제 구현 | Gap 분석 | 다음 액션 |
|-------|------|-----------|----------|-----------|
| **Phase 0** | 기본 설정 | ✅ 100% 완료 | 없음 | - |
| **Phase 1** | Auth 4개 화면 | ✅ 100% 완료 | 없음 | - |
| **Phase 2** | Onboarding | ✅ 100% 완료 | 없음 | - |
| **Phase 3** | Home + Nav | ✅ 100% 완료 | 없음 | - |
| **Phase 4** | Camera | ✅ 100% 완료 | 없음 | - |
| **Phase 5** | Drug Detail | 🔄 0% | UI/로직 미구현 | 즉시 시작 가능 |
| **Phase 6** | Settings | 🔄 0% | 전체 미구현 | Phase 5 이후 |
| **Phase 7** | 공통 컴포넌트 | 🔄 0% | 추출 필요 | 병행 가능 |
| **Phase 8** | 라우팅 통합 | 🔄 70% | 일부 경로 미연결 | Phase 6 이후 |
| **Phase 9** | i18n | 🔄 0% | ARB 미생성 | 즉시 시작 필요 |
| **Phase 10** | 최종 검증 | 🔄 0% | - | 모든 Phase 후 |

## 6. 리스크/의존성

### 기술적 리스크

| 항목 | 수준 | 영향 | 완화 방안 |
|------|------|------|-----------|
| **API 미정의** | 높음 | Drug/Settings 기능 차단 | Mock 데이터로 UI 선행 개발 |
| **카메라 권한** | 중간 | iOS 심사 거부 가능 | Info.plist 상세 설명 추가 |
| **성능 (이미지)** | 중간 | 메모리 이슈 | 이미지 캐싱, 압축 전략 |
| **다국어 문장 길이** | 낮음 | UI 깨짐 | Flexible/Expanded 적절 사용 |

### 프로세스 리스크

| 항목 | 수준 | 영향 | 완화 방안 |
|------|------|------|-----------|
| **코드 리뷰 부재** | 중간 | 품질 저하 | PR 템플릿, 체크리스트 활용 |
| **테스트 커버리지** | 중간 | 버그 증가 | 핵심 로직 우선 테스트 |
| **문서 업데이트** | 낮음 | 혼란 발생 | 각 Phase 완료시 즉시 갱신 |

## 7. 검토 요청

### 🎯 의사결정 필요 사항

#### A. i18n 적용 시점

| 옵션 | 장점 | 단점 | 추천 |
|------|------|------|------|
| **A-1: 즉시 전체 적용** | 일관성, 재작업 방지 | 개발 속도 저하 | ✅ |
| **A-2: Phase 9에서 일괄** | 빠른 개발 | 대규모 수정 필요 | - |

**결정**: A-1 선택 - ARB 파일 즉시 생성, 신규 개발시 바로 적용

#### B. 공통 컴포넌트 추출 시점

| 옵션 | 장점 | 단점 | 추천 |
|------|------|------|------|
| **B-1: Phase 7 집중** | 체계적 정리 | 중복 코드 임시 허용 | - |
| **B-2: 발견 즉시 추출** | 중복 최소화 | 개발 흐름 중단 | ✅ |

**결정**: B-2 선택 - 3회 이상 반복시 즉시 core/widgets로 추출

### ✅ 우선 실행 Top 5

1. **ARB 파일 생성 및 l10n 설정** (5분)
2. **withOpacity → withValues 전체 교체** (10분)  
3. **StateProvider → AsyncNotifier 마이그레이션** (15분)
4. **Phase 5 Drug Detail 시작** (1시간)
5. **테스트 구조 수립 및 첫 테스트 작성** (30분)

### 📊 품질 체크리스트

| 항목 | 기준 | 검증 방법 | 현재 | 목표 |
|------|------|-----------|------|------|
| **코드 품질** | flutter analyze 에러 0 | `flutter analyze` | ✅ 0 | 0 |
| **포맷팅** | 전체 파일 포맷 적용 | `flutter format . --set-exit-if-changed` | ⚠️ | 100% |
| **테스트 커버리지** | 핵심 로직 80% | `flutter test --coverage` | 10% | 80% |
| **문장 길이** | 모든 UI 텍스트 2줄 이내 | ARB 파일 검토 | - | 100% |
| **성능** | 60fps 유지 | Performance Overlay | ✅ | 60fps |
| **접근성** | Semantics 적용 | Flutter Inspector | 30% | 80% |

---

## 📌 최종 승인 요청

위 분석 결과를 바탕으로 다음과 같이 진행하고자 합니다:

1. **즉시 실행 작업** 완료 (30분)
2. **Phase 5 Drug Detail** 구현 시작 (1시간)
3. **i18n 기반** 구축 및 점진 적용
4. **테스트 구조** 수립 및 핵심 테스트 우선 작성

**승인 여부를 확인해 주시면 즉시 실행하겠습니다.**

*문서 생성: 2025-09-03 / PillSnap INIT System*