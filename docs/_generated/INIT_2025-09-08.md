# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-08)

## 📋 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|--------|
| API_INTEGRATION.md | docs/ | 2025-09-07 21:56 | API 연동, 이미지 전처리, pillsnap.co.kr |
| ARCHITECTURE.md | docs/ | 2025-09-07 21:55 | Feature-first, Clean Architecture, 이미지 파이프라인 |
| IMAGE_PREPROCESSING_PIPELINE.md | docs/ | 2025-09-06 19:47 | 이미지 표준화, 2048px, JPEG Q95, ROI |
| CLAUDE_MEMORY.md | docs/ | 2025-09-06 19:30 | 절대 수칙 10개, 즉시 실행, Phase 상태 |
| implementation_guide.md | docs/2025-09-05_ | 2025-09-05 20:32 | 촬영 내역, 즐겨찾기, Repository 구현 |
| remaining_features.md | docs/2025-09-05_ | 2025-09-05 20:30 | 남은 기능, 구현 가이드 |
| signup-flow-fixes.md | docs/2025-01-03_ | 2025-09-05 00:36 | 회원가입 플로우, 에러 처리 |
| supabase_integration.md | docs/2025-09-04_ | 2025-09-04 20:06 | Supabase, 인증, 테이블 Phase 2 |
| supabase_schema.md | docs/2025-09-04_ | 2025-09-04 19:50 | DB 스키마, 마이그레이션 |
| flutter_architecture_guide.md | docs/2025-09-02_ | 2025-09-02 18:54 | Layered Architecture, 구현 패턴 |

## 🏗️ 아키텍처 규칙 (정규화 본문)

### 1. 폴더 구조 표준

**절대 규칙**: `features/<feature>/{presentation,domain,data}` 계층 필수

```
lib/
├── core/                       # 앱 전역 공통
│   ├── error/                  # 에러 처리 (exceptions, failures)
│   ├── network/                # 네트워크 설정 (api_client)
│   ├── widgets/                # 공통 위젯
│   ├── utils/                  # 유틸리티
│   │   ├── validators.dart
│   │   ├── formatters.dart
│   │   └── structured_logger.dart  # 구조화 로깅
│   ├── router/                 # go_router 설정
│   │   ├── app_router.dart     # 라우터 구성
│   │   └── route_paths.dart    # 🔴 라우트 경로 상수 (필수 생성)
│   └── i18n/                   # 국제화 헬퍼
├── theme/                      # 디자인 시스템
│   ├── app_theme.dart          # Material 테마
│   ├── app_colors.dart         # 색상 토큰
│   ├── app_typography.dart     # 타이포그래피
│   ├── app_spacing.dart        # 간격 시스템 (xs/sm/md/lg/xl/xxl)
│   └── app_dimensions.dart     # 크기, 반경
├── features/
│   └── <feature>/
│       ├── presentation/       # UI 레이어
│       │   ├── pages/          # 화면 컴포넌트
│       │   ├── widgets/        # 재사용 위젯
│       │   └── controllers/    # Riverpod Notifier
│       ├── domain/             # 비즈니스 로직
│       │   ├── entities/       # 도메인 모델
│       │   ├── repositories/   # 인터페이스
│       │   └── usecases/       # 유스케이스
│       └── data/               # 데이터 레이어
│           ├── datasources/    # 외부 데이터 소스
│           ├── models/         # freezed 모델
│           └── repositories/   # 구현체
└── l10n/                       # ARB 파일
    ├── app_ko.arb              # 한국어
    └── app_en.arb              # 영어
```

### 2. 라우팅 규칙

- **필수 패키지**: `go_router ^14.0.0`
- **경로 상수**: `core/router/route_paths.dart`에만 정의
- **ShellRoute**: 하단 네비게이션을 위한 공통 레이아웃
- **리다이렉트**: 인증 기반 가드 적용
- **딥링크**: `app_links` 패키지 사용 (uni_links 대체)

### 3. 상태관리 원칙

- **Riverpod 최신 API**: `AsyncNotifier`/`Notifier`만 사용
- **금지 항목**: StateProvider, StateNotifierProvider (레거시)
- **네이밍 규칙**: 
  - Provider: `xxxProvider`
  - Notifier: `XxxNotifier`
  - State: `XxxState`
- **Provider 스코프**: 최상위 ProviderScope 필수

### 4. 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현체(data)
- **UseCase**: 단일 책임, `call()` 메서드
- **Entity**: 불변 객체, `freezed` 사용
- **에러 처리**: `Either<Failure, T>` 또는 명시적 예외

### 5. 테마/토큰 시스템

- **하드코딩 금지**: 모든 스타일값은 토큰 참조
- **색상**: `AppColors.primary`, `AppColors.textPrimary`
- **간격**: `AppSpacing.xs/sm/md/lg/xl/xxl`
- **타이포**: `AppTextStyles.h1/h2/body`
- **🔴 withOpacity 금지**: `withValues(alpha: value)` 사용 필수

### 6. 국제화(i18n)

- **도구**: Flutter gen_l10n
- **ARB 파일**: `lib/l10n/app_ko.arb` (한국어 우선)
- **문장 제한**: 모든 문장 2줄 이내
- **키 네이밍**: `snake_case` (예: `login_button_text`)

### 7. 테스트/품질

- **린트**: `flutter_lints ^3.0.0`
- **분석**: `flutter analyze` 에러 0개 유지
- **코드 생성**: `build_runner` 사용
- **테스트 구조**: `test/{unit,widget,integration}/`

### 8. 이미지 전처리 파이프라인

**책임 분리**:
- **프론트엔드**: 이미지 표준화 (2048px, JPEG Q95, EXIF 픽셀 반영)
- **BFF**: 매직넘버 검증, 재인코딩 판단
- **추론서버**: 모델별 전처리 (center-crop 768, letterbox 1024)

**업로드 규격**:
```dart
class UploadImageSpec {
  static const int targetLongEdge = 2048;
  static const int jpegQuality = 95;
  static const int maxFileSize = 10485760; // 10MB
}
```

### 9. Phase 진행 상태 (2025-09-08 기준 - 실제 확인)

- ✅ **Phase 0-5, 8-9**: 완료 
  - 기본 설정, Auth, Onboarding, Home, Camera, Drug Detail
  - 라우팅 통합 (route_paths.dart 구현됨)
  - i18n (ARB 파일 존재)
- 🔄 **Phase 7**: 부분 완료 (공통 컴포넌트)
- ⏸️ **Phase 6, 10**: 대기 (Settings, 최종 검증)

**전체 진행률**: 85%

## ⚠️ 충돌·중복·누락 리포트 (2025-09-08 업데이트)

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| ✅ ~~라우트 상수 파일 누락~~ | 해결됨 | `route_paths.dart` 구현 완료 | ✅ 해결 |
| ✅ ~~카메라 실제 촬영 미구현~~ | 해결됨 | camera 패키지 연동 완료 | ✅ 해결 |
| ✅ ~~Drug Detail 페이지 미구현~~ | 해결됨 | features/drug 구현 완료 | ✅ 해결 |
| ✅ ~~withOpacity 사용~~ | 해결됨 | withValues(alpha) 교체 완료 | ✅ 해결 |
| **iOS macro 렌즈 미지원** | MacroCameraService 구현중 | 네이티브 채널 연동 필요 | 🟡 중간 |
| **Settings 페이지 미구현** | Phase 6 대기 상태 | 즉시 착수 필요 | 🔴 높음 |
| **백엔드 이중화** | Supabase + PillSnap API 병존 | 역할 분리 유지 | 🟢 낮음 |

## ✅ 실행 체크리스트 (업데이트)

### ✅ 완료된 작업

- [x] **라우팅 상수 파일 생성** - `lib/core/router/route_paths.dart` 존재
- [x] **l10n 설정 및 ARB 생성** - `lib/l10n/app_ko.arb`, `app_en.arb` 존재
- [x] **withOpacity 교체** - withValues(alpha) 사용중
- [x] **Drug Detail 페이지 구현** - `lib/features/drug/` 완료
- [x] **카메라 촬영 기능 연동** - camera 패키지 연동 완료

### 🔴 즉시 필요 작업 (이번 주)

- [ ] **Settings 페이지 구현** (난이도: M, 2시간)
  - 프로필 관리
  - 알림 설정
  - 앱 정보
  - 로그아웃

- [ ] **iOS macro 렌즈 연동** (난이도: L, 3시간)
  - 네이티브 Swift 코드 작성
  - MethodChannel 연결
  - MacroCameraService 완성

- [ ] **실제 API 연동 테스트** (난이도: M, 2시간)
  - pillsnap.co.kr API 테스트
  - 이미지 업로드
  - 분석 결과 파싱

- [ ] **촬영 내역 저장/조회** (난이도: M, 2시간)
  - Supabase captures 테이블 연동
  - 이미지 Storage 업로드
  - 내역 조회 UI

- [ ] **즐겨찾기 기능** (난이도: S, 1시간)
  - favorites 테이블 연동
  - UI 구현

### 🟢 중간 우선순위 (다음 주)

- [ ] **내가 먹는 약 등록** (난이도: M, 2시간)
- [ ] **알러지 정보 관리** (난이도: S, 1시간)
- [ ] **알림 설정** (난이도: M, 3시간)
- [ ] **검색 기록** (난이도: S, 1시간)
- [ ] **약물 상호작용 체크** (난이도: L, 4시간)
- [ ] **오프라인 모드** (난이도: L, 4시간)

## 📊 Phase 맵핑 (Gap 분석 - 실제 상태)

| Phase | 계획 항목 | 현재 상태 | Gap | 조치 필요 |
|-------|-----------|-----------|-----|-----------|
| 0 | 기본 설정 | ✅ 완료 | 0% | - |
| 1 | Auth (인증) | ✅ 완료 | 0% | - |
| 2 | Onboarding | ✅ 완료 | 0% | - |
| 3 | Home | ✅ 완료 | 0% | - |
| 4 | Camera | ✅ 완료 | 0% | iOS macro 렌즈 추가 작업중 |
| 5 | Drug Detail | ✅ 완료 | 0% | - |
| 6 | Settings | ⏸️ 대기 | 100% | 즉시 착수 필요 |
| 7 | 공통 컴포넌트 | 🔄 진행중 | 50% | 점진적 추출 |
| 8 | 라우팅 통합 | ✅ 완료 | 0% | - |
| 9 | i18n | ✅ 완료 | 0% | - |
| 10 | 최종 검증 | ⏸️ 대기 | 100% | Phase 6 완료 후 |

## 🚨 리스크/의존성

### 외부 의존성
- **Supabase**: 인증/데이터 저장 (설정 완료)
- **PillSnap API**: 약품 분석 (https://api.pillsnap.co.kr)
- **카메라 권한**: iOS/Android 설정 필요

### 기술적 리스크
- **이미지 크기**: 10MB 제한, 2048px 표준화 필수
- **네트워크 처리**: 오프라인 모드 미지원
- **iOS 빌드**: Xcode 설정 필요

### 성능 고려사항
- 이미지 전처리 isolate 사용
- drug_cache 테이블 활용
- 레이지 로딩 적용

## 📱 백엔드 정보

### PillSnap API
- **URL**: https://api.pillsnap.co.kr
- **Key**: YOUR_API_KEY_HERE
- **용도**: 약품 이미지 분석, 약품 정보 조회

### Supabase
- **URL**: https://dcpuiwszzyoojgikszaa.supabase.co
- **Anon Key**: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
- **용도**: 사용자 인증, 데이터 저장
- **테이블**: profiles, captures, favorites, medications 등 10개

## 🔍 검토 요청

### A. 모순 해결안 선택

**이슈**: 백엔드 이중화 (Supabase + API)
- **옵션 A**: Supabase 인증/저장, API 분석 역할 분리 ✅ (권장)
- **옵션 B**: Supabase로 완전 통합

### B. 우선 적용 Phase Top 5

1. **route_paths.dart 생성** - 블로커 해결
2. **Drug Detail 페이지** - 핵심 기능
3. **카메라 실제 촬영** - 핵심 기능
4. **l10n 설정** - 기반 작업
5. **촬영 내역 저장** - 데이터 관리

### C. QA 체크 항목

| 항목 | 체크 | 비고 |
|------|------|------|
| 문장 2줄 제한 | ⚠️ | ARB 파일 검토 필요 |
| 접근성 | ⚠️ | Semantics 추가 필요 |
| 다국어 (ko/en) | 🔄 | ARB 파일 작성 중 |
| 반응형 | ✅ | LayoutBuilder 사용 |
| withOpacity 제거 | ⚠️ | 검색 후 교체 필요 |
| 하드코딩 제거 | 🔄 | 테마 토큰 적용 중 |

---

**작성일**: 2025-09-08  
**검토자**: PillSnap Engineering Team  
**다음 업데이트**: Phase 5 완료 후