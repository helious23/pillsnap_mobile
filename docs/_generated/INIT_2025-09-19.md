# PillSnap INIT — 아키텍처/계획 온보딩 (2025-09-19)

## 📋 문서 인덱스 요약 (최신 10개)

| 파일명 | 경로 | 수정일 | 키워드 |
|--------|------|--------|--------|
| CLAUDE_MEMORY.md | docs/ | 2025-09-08 | 절대 수칙 10개, Phase 상태, 즉시 실행 |
| API_INTEGRATION.md | docs/ | 2025-09-07 | API 연동, pillsnap.co.kr, X-Api-Key |
| ARCHITECTURE.md | docs/ | 2025-09-07 | Feature-first, Clean Architecture, 이미지 파이프라인 |
| IMAGE_PREPROCESSING_PIPELINE.md | docs/ | 2025-09-06 | 이미지 표준화, 2048px, JPEG Q95, ROI |
| implementation_guide.md | docs/2025-09-05_ | 2025-09-05 | 촬영 내역, 즐겨찾기, Repository 구현 |
| remaining_features.md | docs/2025-09-05_ | 2025-09-05 | 남은 기능, 우선순위, My Medications |
| signup-flow-fixes.md | docs/2025-01-03_ | 2025-09-05 | 회원가입 플로우, 에러 처리 |
| supabase_integration.md | docs/2025-09-04_ | 2025-09-04 | Supabase 연동, 인증, Phase 2 테이블 |
| supabase_schema.md | docs/2025-09-04_ | 2025-09-04 | DB 스키마, profiles, captures, favorites |
| migration_plan.md | docs/2025-09-03_ | 2025-09-03 | Phase 0-10, 14시간 예상, 체크리스트 |

## 🏗️ 아키텍처 규칙 (정규화 본문)

### 1. 폴더 구조 표준

**절대 경로 규칙**: `features/<feature>/{presentation,domain,data}` 계층 필수

```
lib/
├── core/                       # 앱 전역 공통
│   ├── error/                  # exceptions.dart, failures.dart 
│   ├── network/                # api_client.dart, network_info.dart
│   ├── widgets/                # buttons/, cards/, loading/, dialogs/
│   ├── utils/                  
│   │   ├── validators.dart     # 입력 검증
│   │   ├── formatters.dart     # 포맷 유틸
│   │   └── structured_logger.dart  # trace_id 기반 로깅
│   ├── router/                 
│   │   ├── app_router.dart     # go_router 구성
│   │   └── route_paths.dart    # 🔴 경로 상수 (필수)
│   └── i18n/                   # 국제화 헬퍼
├── theme/                      
│   ├── app_theme.dart          # Material 3 테마
│   ├── app_colors.dart         # 색상 토큰
│   ├── app_typography.dart     # 타이포그래피 토큰  
│   ├── app_spacing.dart        # xs/sm/md/lg/xl/xxl
│   └── app_dimensions.dart     # radius, elevation
├── features/
│   └── <feature>/
│       ├── presentation/       
│       │   ├── pages/          # 화면 컴포넌트
│       │   ├── widgets/        # 기능별 위젯
│       │   └── controllers/    # Riverpod Notifier
│       ├── domain/             
│       │   ├── entities/       # freezed 엔티티
│       │   ├── repositories/   # 인터페이스
│       │   └── usecases/       # 단일 책임
│       └── data/               
│           ├── datasources/    # remote/local
│           ├── models/         # freezed + json_serializable
│           └── repositories/   # 구현체
└── l10n/                       
    ├── app_ko.arb              # 한국어 (기본)
    └── app_en.arb              # 영어
```

### 2. 라우팅 규칙

- **패키지**: `go_router ^14.0.0` 필수
- **경로 상수**: `core/router/route_paths.dart`에만 정의
- **ShellRoute**: 하단 네비게이션용
- **인증 가드**: redirect 콜백 활용
- **딥링크**: `app_links` 패키지 (uni_links X)

```dart
// route_paths.dart 예시
class RoutePaths {
  static const login = '/login';
  static const home = '/home';
  static const camera = '/camera';
  static const drugDetail = '/drug/:id';
  static const settings = '/settings';
}
```

### 3. 상태관리 원칙

- **Riverpod 최신 API**: `AsyncNotifier`/`Notifier`만 사용
- **금지**: StateProvider, StateNotifierProvider (레거시)
- **네이밍**:
  - Provider: `xxxProvider`
  - Notifier: `XxxNotifier`  
  - State: `XxxState` (freezed)

### 4. 도메인 규칙

- **Repository 패턴**: 인터페이스(domain) → 구현체(data)
- **UseCase**: `call()` 메서드, 단일 책임
- **Entity**: 불변, `freezed` 필수
- **에러 처리**: `Either<Failure, T>` 또는 명시적 예외

### 5. 테마/토큰 시스템

- **하드코딩 금지**: 모든 값은 토큰 참조
- **색상**: `AppColors.primary`, `AppColors.textPrimary`
- **간격**: `AppSpacing.xs/sm/md/lg/xl/xxl`
- **타이포**: `AppTextStyles.h1/h2/body`
- **🔴 withOpacity 금지**: `withValues(alpha: value)` 필수

### 6. 국제화(i18n)

- **도구**: Flutter gen_l10n
- **ARB**: `lib/l10n/app_ko.arb` 기본
- **문장 제한**: 2줄 이내
- **키 네이밍**: `featureName_componentName_description`

### 7. 테스트/품질

- **analysis_options.yaml**: Effective Dart 규칙
- **테스트 구조**: `test/{unit,widget,integration}/`
- **커버리지**: 최소 80% 목표
- **CI**: flutter analyze, format, test 필수

### 8. Phase 계획

**현재 진행 상태 (85% 완료)**:
- ✅ Phase 0-5: 완료 (기본 설정, Auth, Onboarding, Home, Camera, Drug)
- ✅ Phase 8-9: 완료 (라우팅 통합, i18n)
- ⏸️ Phase 6: Settings (대기)
- 🔄 Phase 7: 공통 컴포넌트 (부분 완료)
- ⏸️ Phase 10: 최종 검증 (대기)

## 📊 충돌·중복·누락 리포트

| 이슈 | 근거 | 권고안 | 리스크 |
|------|------|--------|--------|
| **라우트 상수 누락** | route_paths.dart 파일이 없음 | 즉시 생성 필수 | 🔴 높음 |
| **StateNotifier 사용** | 일부 코드에 레거시 API 잔존 | AsyncNotifier로 마이그레이션 | 🟡 중간 |
| **이미지 전처리 책임** | 프론트/BFF/추론서버 경계 모호 | 문서대로 명확히 분리 | 🟡 중간 |
| **withOpacity 사용** | 여러 파일에서 발견 | withValues(alpha)로 교체 | 🟢 낮음 |
| **Settings 페이지 미구현** | Phase 6 대기 상태 | 우선 구현 필요 | 🟡 중간 |
| **테스트 코드 부족** | test/ 디렉터리 빈약 | 핵심 기능 테스트 작성 | 🟡 중간 |

## ✅ 실행 체크리스트

### 🔴 즉시 실행 (1시간 이내)

- [ ] **라우트 상수 파일 생성** (난이도: S, 10분, 블로커: 없음)
  ```bash
  touch lib/core/router/route_paths.dart
  # 모든 경로 상수 마이그레이션
  ```

- [ ] **withOpacity → withValues 교체** (난이도: S, 20분, 블로커: 없음)
  ```bash
  grep -r "withOpacity" lib/
  # 발견된 모든 파일에서 withValues(alpha: value)로 교체
  ```

- [ ] **환경 변수 설정 확인** (난이도: S, 5분, 블로커: 없음)
  ```bash
  flutter run \
    --dart-define=API_URL=https://api.pillsnap.co.kr \
    --dart-define=API_KEY=YOUR_API_KEY_HERE \
    --dart-define=SUPABASE_URL=https://dcpuiwszzyoojgikszaa.supabase.co
  ```

### 🟡 단기 실행 (오늘 중)

- [ ] **Settings 페이지 구현** (난이도: M, 2시간, 블로커: 없음)
  - 프로필 관리
  - 알러지 정보
  - 알림 설정
  - 언어 변경

- [ ] **StateNotifier → AsyncNotifier 마이그레이션** (난이도: M, 3시간, 블로커: 기존 코드 의존성)
  - DrugResultNotifier
  - DrugDetailNotifier
  - CameraNotifier

- [ ] **핵심 테스트 작성** (난이도: M, 3시간, 블로커: 없음)
  - auth_repository_test.dart
  - drug_usecase_test.dart
  - camera_page_test.dart

### 🟢 중기 실행 (이번 주)

- [ ] **즐겨찾기 기능 완성** (난이도: M, 2시간, 블로커: Supabase 테이블)
  - favorites 테이블 활용
  - UI 버튼 추가
  - 홈 화면 연동

- [ ] **촬영 내역 저장** (난이도: M, 2시간, 블로커: captures 테이블)
  - 이미지 업로드
  - 메타데이터 저장
  - 히스토리 조회

- [ ] **iOS macro 렌즈 지원** (난이도: L, 3시간, 블로커: 네이티브 코드)
  - Swift 브릿지 구현
  - 렌즈 전환 로직

- [ ] **CI/CD 파이프라인** (난이도: M, 2시간, 블로커: GitHub Actions)
  ```yaml
  - flutter analyze
  - flutter format --set-exit-if-changed
  - flutter test
  - flutter build apk/ios
  ```

## 🗺️ Phase 맵핑

| Phase | 상태 | Gap 분석 | 남은 작업 |
|-------|------|----------|-----------|
| 0. 기본 설정 | ✅ 완료 | - | - |
| 1. Auth | ✅ 완료 | - | - |
| 2. Onboarding | ✅ 완료 | - | - |
| 3. Home | ✅ 완료 | - | - |
| 4. Camera | ✅ 완료 | macro 렌즈 미지원 | iOS 네이티브 코드 |
| 5. Drug Detail | ✅ 완료 | - | - |
| 6. Settings | ⏸️ 대기 | 전체 미구현 | 페이지 구현 |
| 7. 공통 컴포넌트 | 🔄 진행 | 일부 위젯 누락 | 추출 및 정리 |
| 8. 라우팅 통합 | ✅ 완료 | route_paths.dart 누락 | 상수 파일 생성 |
| 9. i18n | ✅ 완료 | - | - |
| 10. 최종 검증 | ⏸️ 대기 | 테스트 부족 | 테스트 작성 |

## ⚠️ 리스크/의존성

| 항목 | 설명 | 영향도 | 대응 방안 |
|------|------|--------|-----------|
| **API 서버 의존성** | pillsnap.co.kr 가용성 | 🔴 높음 | 오프라인 모드 구현 |
| **Supabase 제한** | 무료 티어 한계 | 🟡 중간 | 사용량 모니터링 |
| **iOS 심사** | 카메라 권한 설명 | 🟡 중간 | 명확한 설명 작성 |
| **이미지 처리 성능** | 2048px 리사이징 | 🟢 낮음 | Isolate 활용 중 |

## 📝 검토 요청

### A. 모순 해결안 선택

**StateNotifier vs AsyncNotifier 마이그레이션**
- [ ] **A안**: 점진적 마이그레이션 (기능별 순차 진행)
- [ ] **B안**: 전체 일괄 마이그레이션 (한번에 교체)
- **권고**: A안 (리스크 최소화)

### B. 우선 적용 Phase Top 5

1. **라우트 상수 파일 생성** - 즉시
2. **Settings 페이지 구현** - Phase 6
3. **테스트 코드 작성** - Phase 10 일부
4. **즐겨찾기 기능** - 추가 기능
5. **CI/CD 설정** - Phase 10 일부

### C. QA 체크 항목

| 항목 | 체크 | 비고 |
|------|------|------|
| 문장 줄바꿈 2줄 제한 | ⚠️ | ARB 파일 검토 필요 |
| 접근성 (Semantics) | ❌ | 미적용 |
| 다국어 (ko/en) | ✅ | ARB 파일 존재 |
| 반응형 (태블릿) | ⚠️ | 부분 지원 |
| withOpacity 제거 | ⚠️ | 일부 남음 |
| 하드코딩 제거 | ✅ | 토큰 사용 중 |

---

*문서 생성: 2025-09-19*
*다음 검토: 2025-09-20*