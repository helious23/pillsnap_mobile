# ì´ë¯¸ì§€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ë¬¸ì„œ

ì‘ì„±ì¼: 2025-09-06  
ë²„ì „: 1.0.0

## ğŸ“‹ ê°œìš”

PillSnap í”„ë¡ íŠ¸ì—”ë“œì˜ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì€ ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬ì—ì„œ ì·¨ë“í•œ ê³ í•´ìƒë„ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ í‘œì¤€í™”ëœ ì—…ë¡œë“œ ê·œê²©ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

## ğŸ¯ í•µì‹¬ ì›ì¹™

### ì±…ì„ ë¶„ë¦¬

- **í”„ë¡ íŠ¸ì—”ë“œ**: ì´ë¯¸ì§€ í‘œì¤€í™” (2048px, JPEG Q95, EXIF ì²˜ë¦¬)
- **BFF**: ë§¤ì§ë„˜ë²„ ê²€ì¦, ì¬ì¸ì½”ë”© ì—¬ë¶€ íŒë‹¨
- **ì¶”ë¡ ì„œë²„**: ëª¨ë¸ë³„ ì „ì²˜ë¦¬ (center-crop 768, letterbox 1024, ì •ê·œí™”)

### ì—…ë¡œë“œ ë‹¨ìœ„ ê³„ì•½

í”„ë¡ íŠ¸ì—”ë“œëŠ” ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬ ì›ë³¸ì„ ë‹¤ìŒ ê·œê²©ìœ¼ë¡œ í‘œì¤€í™”:
- **ê¸´ ë³€**: â‰¤ 2048px (ëŒ€ë¶€ë¶„ 2048ë¡œ ë‹¤ìš´ìŠ¤ì¼€ì¼)
- **í¬ë§·**: JPEG (Q=95)
- **EXIF**: í”½ì…€ì— ë°˜ì˜ (bakeOrientation)
- **ë©”íƒ€ë°ì´í„°**: ì œê±°
- **ê²½ë¡œ**: `/tmp/upload_ready_*.jpg`

## ğŸ“ í‘œì¤€ ê·œê²© (UploadImageSpec)

```dart
class UploadImageSpec {
  static const int targetLongEdge = 2048;     // ëª©í‘œ ê¸´ ë³€ (ëŒ€ë¶€ë¶„ ì´ í¬ê¸°ë¡œ ë‹¤ìš´ìŠ¤ì¼€ì¼)
  static const int minLongEdge = 1024;        // ìµœì†Œ ê¸´ ë³€ (ì—…ìŠ¤ì¼€ì¼ ê¸ˆì§€)
  static const int maxLongEdge = 4096;        // ìµœëŒ€ ê¸´ ë³€ (ì´ˆëŒ€í˜• ë³´í˜¸)
  static const int jpegQuality = 95;          // JPEG í’ˆì§ˆ (92-95 ê¶Œì¥)
  
  // ì„œë²„ ì „ì²˜ë¦¬ ëª©í‘œ (ì°¸ê³ )
  static const int classificationTargetSize = 768;  // ë¶„ë¥˜: center-crop
  static const int detectionTargetSize = 1024;      // ê°ì§€: letterbox
  static const int roiSize = 512;                   // ROI: ì¤‘ì•™ ì •ì‚¬ê°í˜•
}
```

## ğŸ”„ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

### 1. ì´ë¯¸ì§€ ìº¡ì²˜/ì„ íƒ
- **ì¹´ë©”ë¼**: `ResolutionPreset.max` â†’ ë„¤ì´í‹°ë¸Œ ê³ í•´ìƒë„ (ì˜ˆ: 4032Ã—3024)
- **ê°¤ëŸ¬ë¦¬**: ì›ë³¸ í’ˆì§ˆ ìœ ì§€

### 2. ì „ì²˜ë¦¬ ë‹¨ê³„ (_processImageInIsolate)

1. **íŒŒì¼ ë¡œë“œ & ë””ì½”ë“œ**
   - SHA256 í•´ì‹œ ê³„ì‚° (ë””ë²„ê¹…ìš©)
   - ì›ë³¸ í¬ê¸°/í•´ìƒë„ ë¡œê¹…

2. **EXIF Orientation ë°˜ì˜**
   - `img.bakeOrientation()` â†’ í”½ì…€ì— íšŒì „ ì ìš©
   - ë©”íƒ€ë°ì´í„°ê°€ ì•„ë‹Œ ì‹¤ì œ í”½ì…€ ë³€í™˜

3. **ë¹„ìœ¨ ìœ ì§€ ë‹¤ìš´ìŠ¤ì¼€ì¼**
   ```
   if (longEdge > 4096) â†’ 4096ìœ¼ë¡œ ì¶•ì†Œ
   else if (longEdge > 2048) â†’ 2048ë¡œ ì¶•ì†Œ (ê°€ì¥ í”í•¨)
   else if (longEdge < 1024) â†’ ì›ë³¸ ìœ ì§€ (ì—…ìŠ¤ì¼€ì¼ ê¸ˆì§€)
   else â†’ ì›ë³¸ ìœ ì§€
   ```

4. **JPEG ì¬ì¸ì½”ë”©**
   - í’ˆì§ˆ: Q=95
   - ìƒ‰ê³µê°„: sRGB
   - ë©”íƒ€ë°ì´í„°: ì œê±°

5. **ì„ì‹œ íŒŒì¼ ì €ì¥**
   - ê²½ë¡œ: `/tmp/upload_ready_<timestamp>.jpg`
   - ì´ íŒŒì¼ì´ ì‹¤ì œ ì—…ë¡œë“œ ëŒ€ìƒ

### 3. ê²°ê³¼ ë©”íƒ€ë°ì´í„° (ProcessedImageResult)

```dart
class ProcessedImageResult {
  final String path;          // ì—…ë¡œë“œ íŒŒì¼ ê²½ë¡œ
  final int width;            // ìµœì¢… ë„ˆë¹„
  final int height;           // ìµœì¢… ë†’ì´
  final int fileSize;         // íŒŒì¼ í¬ê¸° (bytes)
  final String hash;          // SHA256 í•´ì‹œ (ì• 12ì)
  final bool wasResized;      // ë¦¬ì‚¬ì´ì¦ˆ ì—¬ë¶€
  final double scaleFactor;   // ìŠ¤ì¼€ì¼ íŒ©í„°
  final bool exifFixed;       // EXIF ìˆ˜ì • ì—¬ë¶€
  final String traceId;       // ì¶”ì  ID
}
```

## ğŸ“Š ë¡œê¹… ì‹œìŠ¤í…œ

### êµ¬ì¡°í™”ëœ ë¡œê·¸ (StructuredLogger)

```json
{
  "timestamp": "2025-09-06T10:00:00Z",
  "level": "info",
  "stage": "image_processing",
  "traceId": "uuid-v4",
  "data": {
    "phase": "final",
    "processed": {
      "width": 2048,
      "height": 1536,
      "size": 245760,
      "sizeKB": "240.0"
    },
    "wasResized": true,
    "scaleFactor": "0.51",
    "exifFixed": false,
    "decision": "larger_than_desired"
  }
}
```

### ë¡œê·¸ ë‹¨ê³„

1. **original**: ì›ë³¸ ì´ë¯¸ì§€ ì •ë³´
2. **exif_fixed**: EXIF ì²˜ë¦¬ í›„ (ë³€ê²½ëœ ê²½ìš°ë§Œ)
3. **resize_decision**: ë¦¬ì‚¬ì´ì¦ˆ ê²°ì • (too_large/larger_than_desired/size_ok/too_small_keep_original)
4. **resized**: ë¦¬ì‚¬ì´ì¦ˆ í›„ (ìˆ˜í–‰ëœ ê²½ìš°ë§Œ)
5. **final**: ìµœì¢… ê²°ê³¼
6. **compression**: ì••ì¶•ë¥  ì •ë³´

## âš ï¸ ì—ëŸ¬ ì²˜ë¦¬

### ProcessingException

```dart
class ProcessingException implements Exception {
  final String message;
  final String? originalPath;
  final Map<String, dynamic>? metadata;
}
```

- ì›ë³¸ ë°˜í™˜ ëŒ€ì‹  **ëª…ì‹œì  ì˜ˆì™¸** ë°œìƒ
- UIì— ì ì ˆí•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
- ì¬ì‹œë„ ë¡œì§ í™œì„±í™”

## ğŸ”§ ROI (Region of Interest)

### ê¸°ë³¸ ì •ì±…
- **ê¸°ë³¸ ë¹„í™œì„±í™”** (ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ì ˆê°)
- ì €ì‹ ë¢° í´ë°± ê²½ë¡œì—ì„œë§Œ í™œì„±í™”

### í™œì„±í™” ì¡°ê±´ (í–¥í›„ êµ¬í˜„)
```dart
bool _shouldGenerateROI() {
  // TODO: ì„œë²„ ì‘ë‹µ ê¸°ë°˜ íŒë‹¨
  // - ê°ì§€ ì‹ ë¢°ë„ < 0.35
  // - ë¶„ë¥˜ í™•ë¥  < 0.65
  // - ë°°ê²½ ê³¼ë…¸ì¶œ/ì €ëŒ€ë¹„
  return false;  // í˜„ì¬ëŠ” í•­ìƒ false
}
```

### ROI ìƒì„±
- ì¤‘ì•™ ì •ì‚¬ê°í˜• í¬ë¡­
- 512Ã—512 ë¦¬ì‚¬ì´ì¦ˆ
- ë³„ë„ íŒŒì¼ë¡œ ì €ì¥ (`roi_<timestamp>.jpg`)
- ë©”ì¸ ì´ë¯¸ì§€ì™€ ë³„ê°œ ì „ì†¡

## ğŸ“± ì‹¤ì œ ì˜ˆì‹œ

### ê°€ë¡œ ì‚¬ì§„ (iPhone)
```
ì›ë³¸: 4032Ã—3024 (3.2MB)
  â†“ EXIF ì²˜ë¦¬
  â†“ ë‹¤ìš´ìŠ¤ì¼€ì¼ (larger_than_desired)
ìµœì¢…: 2048Ã—1536 (240KB)
ì••ì¶•ë¥ : 92.5%
```

### ì„¸ë¡œ ì‚¬ì§„ (Android)
```
ì›ë³¸: 2268Ã—4032 (2.8MB)
  â†“ EXIF ì²˜ë¦¬ (90ë„ íšŒì „ ë°˜ì˜)
  â†“ ë‹¤ìš´ìŠ¤ì¼€ì¼ (larger_than_desired)
ìµœì¢…: 2048Ã—1152 (185KB)
ì••ì¶•ë¥ : 93.4%
```

## âœ… QA ì²´í¬ë¦¬ìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ê³ í•´ìƒë„ ê°€ë¡œ/ì„¸ë¡œ ì‚¬ì§„**
   - [ ] ê¸´ ë³€ì´ 2048ë¡œ ë‹¤ìš´ìŠ¤ì¼€ì¼ í™•ì¸
   - [ ] EXIF íšŒì „ì´ í”½ì…€ì— ë°˜ì˜ í™•ì¸
   - [ ] ë©”íƒ€ë°ì´í„° ì œê±° í™•ì¸

2. **ì €í•´ìƒë„ ì‚¬ì§„ (<1024px)**
   - [ ] ì—…ìŠ¤ì¼€ì¼ ë˜ì§€ ì•ŠìŒ í™•ì¸
   - [ ] ì›ë³¸ í¬ê¸° ìœ ì§€ í™•ì¸

3. **ê°¤ëŸ¬ë¦¬ ì„ íƒ**
   - [ ] ì¹´ë©”ë¼ì™€ ë™ì¼í•œ íŒŒì´í”„ë¼ì¸ ì ìš©
   - [ ] ì¼ê´€ëœ í’ˆì§ˆ/í¬ê¸°

4. **ë¡œê·¸ í™•ì¸**
   - [ ] ê° ë‹¨ê³„ë³„ êµ¬ì¡°í™”ëœ ë¡œê·¸ ì¶œë ¥
   - [ ] traceIdë¡œ ì „ì²´ íë¦„ ì¶”ì  ê°€ëŠ¥

## ğŸš€ í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì ì‘í˜• í’ˆì§ˆ ì¡°ì •**
   - ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¥¸ JPEG í’ˆì§ˆ ë™ì  ì¡°ì •
   - 5G: Q95, 4G: Q90, 3G: Q85

2. **ROI ì§€ëŠ¥í˜• í™œì„±í™”**
   - ì„œë²„ í”¼ë“œë°± ê¸°ë°˜ ìë™ íŒë‹¨
   - íˆìŠ¤í† ê·¸ë¨ ë¶„ì„ìœ¼ë¡œ ì €ëŒ€ë¹„ ê°ì§€

3. **ë³‘ë ¬ ì²˜ë¦¬**
   - ë‹¤ì¤‘ ì´ë¯¸ì§€ ë™ì‹œ ì²˜ë¦¬
   - ì—…ë¡œë“œ í ê´€ë¦¬

4. **ìºì‹± ì „ëµ**
   - ì²˜ë¦¬ëœ ì´ë¯¸ì§€ ì„ì‹œ ìºì‹±
   - ì¬ì „ì†¡ ì‹œ ì¬ì²˜ë¦¬ ë°©ì§€

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [API_INTEGRATION.md](./API_INTEGRATION.md)
- [ARCHITECTURE.md](./ARCHITECTURE.md)
- [IMAGE_OPTIMIZATION_GUIDE.md](./IMAGE_OPTIMIZATION_GUIDE.md)